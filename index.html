<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Punk Noodles ‚Äî Back Office (Code PIN)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- ‚úÖ PDF (jsPDF + AutoTable) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.3/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root{
      /* üé® Punk Noodles ‚Äî Candy Red + Salmon */
      --bg-main:#07060a;
      --bg-card:#121018;
      --bg-card-soft:#171423;

      --candy:#ff2d55;        /* rouge-bonbon */
      --salmon:#ff7a90;       /* saumon */
      --candy-deep:#b3122e;

      --text-main:#fbfbff;
      --text-muted:#a6a2b3;

      --danger:#ef4444;
      --success:#22c55e;

      --ring: rgba(255,45,85,.45);
      --stroke: rgba(255,255,255,.08);
      --stroke-strong: rgba(255,255,255,.12);
      --glass: rgba(12, 10, 18, .72);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        radial-gradient(900px 450px at 15% 0%, rgba(255,45,85,.22), transparent 55%),
        radial-gradient(900px 450px at 85% 0%, rgba(255,122,144,.18), transparent 55%),
        radial-gradient(circle at top, #171323 0, #07060a 55%);
      color:var(--text-main);
      min-height:100vh;
    }
    .hidden{display:none!important}

    header{
      padding:16px 24px;
      border-bottom:1px solid rgba(255,122,144,.22);
      display:flex;
      align-items:center;
      justify-content:space-between;
      background: linear-gradient(to right, rgba(0,0,0,.86), rgba(14,8,16,.86));
      position:sticky;
      top:0;
      z-index:5;
      backdrop-filter: blur(8px);
    }
    .title-block{display:flex;flex-direction:column;gap:4px}
    .title-block h1{
      margin:0;
      font-size:18px;
      letter-spacing:.10em;
      text-transform:uppercase;
      color:var(--salmon);
    }
    .title-block span{font-size:12px;color:var(--text-muted)}
    .user-info-bar{display:flex;align-items:center;gap:10px;font-size:13px;color:var(--text-muted)}
    .role-badge{
      padding:4px 10px;border-radius:999px;
      border:1px solid rgba(255,122,144,.35);
      font-size:11px;text-transform:uppercase;letter-spacing:.06em;
      background: rgba(255,122,144,.06);
      color: #ffd0d8;
    }

    .btn{
      border:none; outline:none;
      background: linear-gradient(135deg, var(--candy), var(--salmon));
      color:#120611;
      padding:9px 14px;
      border-radius:999px;
      font-size:13px;
      cursor:pointer;
      font-weight:800;
      transition: transform .08s ease, box-shadow .12s ease, filter .12s ease;
      box-shadow: 0 10px 30px rgba(255,45,85,.18);
    }
    .btn:hover{transform: translateY(-1px); filter:saturate(1.08); box-shadow: 0 16px 40px rgba(255,45,85,.25)}
    .btn:active{transform: translateY(1px) scale(.99)}
    .btn-secondary{
      background: transparent;
      color: var(--text-muted);
      border: 1px solid rgba(255,255,255,.18);
      box-shadow:none;
      font-weight:700;
    }
    .btn-secondary:hover{background: rgba(255,255,255,.04); color:var(--text-main)}
    .btn-danger{background:#7f1d1d;color:#fee2e2}
    .btn-danger:hover{background:#b91c1c}
    .btn-sm{padding:5px 10px;font-size:11px}

    main{padding:24px;max-width:1200px;margin:0 auto}
    .grid{display:grid;grid-template-columns: 1.3fr 1fr;gap:20px}

    .card{
      background:
        radial-gradient(500px 240px at 25% 0%, rgba(255,45,85,.12), transparent 55%),
        radial-gradient(500px 240px at 85% 0%, rgba(255,122,144,.10), transparent 55%),
        rgba(18,16,24,.86);
      border-radius:18px;
      padding:18px 18px 16px;
      border:1px solid rgba(255,255,255,.08);
      box-shadow: 0 18px 60px rgba(0,0,0,.62);
      position:relative;
      overflow:hidden;
    }
    .card::before{
      content:"";
      position:absolute;inset:0;
      background: radial-gradient(circle at top right, rgba(255,45,85,.16), transparent 55%);
      opacity:.7;
      pointer-events:none;
    }
    .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;position:relative;z-index:1}
    .card-title{font-size:12px;text-transform:uppercase;letter-spacing:.14em;color:var(--text-muted)}
    .card-subtitle{font-size:11px;color:var(--text-muted);margin-top:4px}
    .stat-pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 10px;border-radius:999px;
      background: rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.10);
      font-size:11px;color:var(--text-muted)
    }
    .stat-pill span{color:var(--salmon);font-weight:900}

    .separator{margin:12px 0;border-top:1px dashed rgba(255,255,255,.14);position:relative;z-index:1}

    .field-group{display:flex;flex-direction:column;gap:4px;margin-bottom:10px;position:relative;z-index:1}
    .field-group label{font-size:12px;color:var(--text-muted)}
    .field-group input,.field-group textarea,.field-group select{
      background: rgba(0,0,0,.28);
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      padding:9px 10px;
      color:var(--text-main);
      font-size:13px;
      resize:vertical;
      outline:none;
      transition: border-color .12s ease, box-shadow .12s ease;
    }
    .field-group input:focus,.field-group textarea:focus,.field-group select:focus{
      border-color: rgba(255,45,85,.55);
      box-shadow: 0 0 0 4px rgba(255,45,85,.14);
    }
    input::placeholder,textarea::placeholder{color: rgba(166,162,179,.72)}
    .field-row{display:flex;gap:10px}
    .field-row .field-group{flex:1}
    .text-sm{font-size:12px}
    .text-xs{font-size:11px}
    .muted{color:var(--text-muted)}

    .runs-list{
      margin-top:8px;display:flex;flex-direction:column;gap:8px;
      max-height:360px;overflow:auto;padding-right:4px;position:relative;z-index:1
    }
    .run-item{
      border-radius:14px;
      background: rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.10);
      padding:10px 10px 8px;
      display:flex;flex-direction:column;gap:4px;
    }
    .run-header{display:flex;justify-content:space-between;align-items:center;font-size:12px}
    .run-date{color:var(--text-muted);font-size:11px}
    .run-description{font-size:13px;margin-top:4px}
    .run-sales{font-size:11px;color:#ffd0d8;margin-top:2px}

    .run-photo-zone{margin-top:6px;display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .run-photo-zone input[type="file"]{font-size:11px;max-width:260px}

    .photos-preview{margin-top:4px;display:flex;flex-wrap:wrap;gap:6px}
    .photos-preview img{
      width:52px;height:52px;object-fit:cover;border-radius:10px;
      border:1px solid rgba(255,122,144,.45);
      box-shadow: 0 10px 24px rgba(0,0,0,.35);
    }

    .admin-grid{display:grid;grid-template-columns:1fr 1.2fr;gap:20px}
    .stats-row{display:flex;gap:10px;margin-top:6px}
    .stat-card{
      flex:1;
      background: rgba(0,0,0,.28);
      border-radius:14px;
      padding:9px 10px;
      border:1px solid rgba(255,255,255,.10);
      font-size:12px
    }
    .stat-label{color:var(--text-muted);font-size:11px}
    .stat-value{font-size:18px;font-weight:950;color:var(--salmon);letter-spacing:.02em}

    .table{width:100%;border-collapse:collapse;font-size:12px;margin-top:8px}
    .table th,.table td{padding:6px 8px;border-bottom:1px solid rgba(255,255,255,.08)}
    .table th{
      text-align:left;text-transform:uppercase;letter-spacing:.10em;
      font-size:11px;color:var(--text-muted)
    }
    .table tbody tr{cursor:pointer;transition: background .1s ease}
    .table tbody tr:hover{background: rgba(255,255,255,.03)}

    .pill-role{
      padding:2px 8px;border-radius:999px;font-size:10px;
      border:1px solid rgba(255,255,255,.18);
      text-transform:uppercase;letter-spacing:.10em;
      background: rgba(0,0,0,.22);
      color:#ffe1e8;
    }
    .pill-role.admin{border-color: rgba(255,45,85,.55); background: rgba(255,45,85,.12)}
    .pill-role.user,.pill-role.runner,.pill-role.vendeur{border-color: rgba(255,122,144,.42); background: rgba(255,122,144,.08)}
    .badge-soft{
      border-radius:999px;padding:2px 8px;font-size:10px;
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.10);
      color:var(--text-muted)
    }

    .pin-overlay{
      position:fixed;inset:0;
      background:
        radial-gradient(900px 450px at 20% 0%, rgba(255,45,85,.22), transparent 55%),
        radial-gradient(900px 450px at 80% 0%, rgba(255,122,144,.18), transparent 55%),
        radial-gradient(circle at top, #171323 0, #07060a 55%);
      display:flex;align-items:center;justify-content:center;z-index:999
    }
    .pin-card{
      width:320px;max-width:calc(100% - 40px);
      background:
        radial-gradient(500px 240px at 25% 0%, rgba(255,45,85,.14), transparent 55%),
        rgba(10,8,14,.82);
      border-radius:22px;
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 30px 90px rgba(0,0,0,.85);
      padding:18px 18px 16px;
      position:relative;overflow:hidden;
      backdrop-filter: blur(10px);
    }
    .pin-card::before{
      content:"";
      position:absolute;inset:-80px -80px auto auto;
      background: radial-gradient(circle at top right, rgba(255,45,85,.22), transparent 65%);
      opacity:.9;pointer-events:none
    }
    .pin-header{display:flex;align-items:center;justify-content:space-between;position:relative;z-index:1}
    .pin-title{text-transform:uppercase;letter-spacing:.14em;font-size:11px;color:var(--text-muted)}
    .pin-server{font-size:11px;color:var(--salmon);display:flex;align-items:center;gap:6px}
    .pin-server-dot{
      width:6px;height:6px;border-radius:999px;background:#22c55e;
      box-shadow:0 0 10px rgba(34,197,94,.9)
    }

    .pin-screen{
      margin-top:12px;border-radius:16px;background: rgba(0,0,0,.30);
      border:1px solid rgba(255,255,255,.12);
      padding:10px 12px;position:relative;z-index:1
    }
    .pin-label-row{display:flex;align-items:center;justify-content:space-between;font-size:11px;color:var(--text-muted);margin-bottom:4px}
    .pin-display{display:flex;gap:8px;margin-top:4px}
    .pin-dot{
      flex:1;height:32px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.30);
      display:flex;align-items:center;justify-content:center;
      font-size:18px;letter-spacing:.4em
    }
    .pin-dot.filled{
      background: linear-gradient(180deg, rgba(255,45,85,.35), rgba(0,0,0,.25));
      box-shadow: inset 0 0 12px rgba(0,0,0,.8), 0 0 18px rgba(255,45,85,.35);
    }
    .pin-status{margin-top:6px;font-size:11px;color:var(--text-muted)}
    .pin-status-error{color:#fecaca}

    .pin-keypad{
      margin-top:10px;display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:10px;position:relative;z-index:1
    }
    .pin-key{
      height:52px;border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.30);
      color:#f1f1ff;font-size:18px;font-weight:900;
      display:flex;align-items:center;justify-content:center;
      cursor:pointer;position:relative;overflow:hidden;
      transition: transform .06s ease, box-shadow .08s ease, border-color .12s ease;
    }
    .pin-key:hover{
      transform: translateY(-1px);
      box-shadow: 0 12px 30px rgba(0,0,0,.55);
      border-color: rgba(255,45,85,.45);
    }
    .pin-key:active{transform: translateY(1px) scale(.985)}
    .pin-key.action{
      font-size:12px;text-transform:uppercase;letter-spacing:.12em;
      color:#bdb8ca;font-weight:800
    }
    .pin-footer{
      margin-top:10px;display:flex;justify-content:space-between;align-items:center;
      font-size:10px;color:var(--text-muted);position:relative;z-index:1
    }
    .pin-footer strong{color:var(--salmon);text-transform:uppercase;letter-spacing:.08em}

    .car-item{
      background: rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.10);
      padding:10px;border-radius:14px;
      display:flex;justify-content:space-between;align-items:center
    }
    .car-status{font-size:12px}
    .car-free{color:#22c55e}
    .car-taken{color:#ef4444}
    .car-btn{
      padding:7px 10px;border-radius:10px;cursor:pointer;
      background: linear-gradient(135deg, var(--candy), var(--salmon));
      border:none;color:#120611;font-weight:950;font-size:12px
    }
    .car-btn[disabled]{opacity:.5;cursor:not-allowed}

    .tombola-wrap{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:14px;
      margin-top:6px;
    }
    .drum{
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(260px 140px at 30% 20%, rgba(255,45,85,.20), transparent 60%),
        radial-gradient(260px 140px at 75% 25%, rgba(255,122,144,.18), transparent 60%),
        rgba(0,0,0,.24);
      padding:14px;
      position:relative;
      overflow:hidden;
    }
    .drum-head{display:flex;justify-content:space-between;align-items:flex-start;gap:10px}
    .drum-title{
      font-weight:950;letter-spacing:.10em;text-transform:uppercase;color:#ffd0d8;font-size:12px;
    }
    .drum-sub{color:var(--text-muted);font-size:11px;margin-top:4px;line-height:1.4;}
    .drum-visual{
      margin-top:12px;height:160px;display:flex;align-items:center;justify-content:center;position:relative;
    }
    .drum-circle{
      width:130px;height:130px;border-radius:999px;border:2px dashed rgba(255,122,144,.45);
      box-shadow: 0 0 0 10px rgba(255,45,85,.06), 0 0 60px rgba(255,45,85,.18);
      position:relative;
      background: radial-gradient(circle at 30% 25%, rgba(255,45,85,.20), rgba(0,0,0,.12));
      display:flex;align-items:center;justify-content:center;
      user-select:none;
    }
    .drum-circle::after{
      content:"";position:absolute;inset:14px;border-radius:999px;border:1px solid rgba(255,255,255,.10);
      background: radial-gradient(circle at 30% 25%, rgba(255,122,144,.18), transparent 60%);
    }
    .drum-badge{
      position:relative; z-index:2;padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.28);font-size:11px;color:#ffe6ec;letter-spacing:.10em;text-transform:uppercase;font-weight:950;
    }
    .spinning .drum-circle{animation: spin 1.1s linear infinite;border-color: rgba(255,45,85,.7);}
    @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}

    .winner-box{
      margin-top:10px;border-radius:14px;border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);padding:10px;
    }
    .winner-label{font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:.10em}
    .winner-name{font-size:16px;font-weight:950;color:var(--salmon);margin-top:4px}
    .winner-meta{font-size:11px;color:#ffd0d8;margin-top:4px}

    .mini-list{
      max-height:260px;overflow:auto;display:flex;flex-direction:column;gap:8px;padding-right:4px;
    }
    .mini-item{
      border-radius:14px;border:1px solid rgba(255,255,255,.10);background: rgba(0,0,0,.25);padding:10px;
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
    }
    .mini-item strong{display:block}
    .mini-meta{font-size:11px;color:var(--text-muted);margin-top:4px}
    .tag{
      font-size:10px;border-radius:999px;padding:2px 8px;border:1px solid rgba(255,255,255,.12);
      background: rgba(255,122,144,.06);color:#ffd0d8;letter-spacing:.10em;text-transform:uppercase;font-weight:900;white-space:nowrap;
    }

    .recrutement-card{
      background: linear-gradient(135deg, rgba(255,45,85,.30), rgba(255,122,144,.18));
      padding:22px;border-radius:18px;margin-bottom:22px;text-align:center;
      color:#ffeef2;border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 16px 50px rgba(0,0,0,.55);
      position:relative;overflow:hidden;
    }
    .recrutement-card::before{
      content:"";position:absolute;inset:0;background: radial-gradient(circle at 30% 0%, rgba(255,45,85,.35), transparent 55%);
      opacity:.7;pointer-events:none;
    }
    .recrutement-title{
      position:relative;z-index:1;font-size:28px;font-weight:950;letter-spacing:.14em;text-transform:uppercase;margin:0;
    }
    .recrutement-subtitle{
      position:relative;z-index:1;font-size:13px;margin:10px 0 0;color:rgba(255,238,242,.86);
      letter-spacing:.16em;text-transform:uppercase;
    }

    @media (max-width: 900px){
      main{padding:16px}
      .grid,.admin-grid{grid-template-columns:1fr}
      .tombola-wrap{grid-template-columns:1fr}
    }
  </style>
</head>

<body>
  <!-- OVERLAY PIN -->
  <div id="pin-overlay" class="pin-overlay">
    <div class="pin-card">
      <div class="pin-header">
        <div>
          <div class="pin-title">Punk Noodles ‚Äî Secure Access</div>
          <div class="text-xs muted">Entre ton Code PIN pour acc√©der au Back Office.</div>
        </div>
        <div class="pin-server">
          <div class="pin-server-dot"></div>
          <span>Server: <strong>Back Office</strong></span>
        </div>
      </div>

      <div class="pin-screen">
        <div class="pin-label-row">
          <span>IDENTIFIANT</span>
          <span class="text-xs">Code PIN ‚Ä¢ 4 chiffres</span>
        </div>
        <div class="pin-display">
          <div class="pin-dot" id="pin-dot-0"></div>
          <div class="pin-dot" id="pin-dot-1"></div>
          <div class="pin-dot" id="pin-dot-2"></div>
          <div class="pin-dot" id="pin-dot-3"></div>
        </div>
        <div id="pin-status" class="pin-status">Codes g√©r√©s c√¥t√© base de donn√©es (Supabase).</div>
      </div>

      <div class="pin-keypad">
        <div class="pin-key" data-digit="1">1</div>
        <div class="pin-key" data-digit="2">2</div>
        <div class="pin-key" data-digit="3">3</div>
        <div class="pin-key" data-digit="4">4</div>
        <div class="pin-key" data-digit="5">5</div>
        <div class="pin-key" data-digit="6">6</div>
        <div class="pin-key" data-digit="7">7</div>
        <div class="pin-key" data-digit="8">8</div>
        <div class="pin-key" data-digit="9">9</div>
        <div class="pin-key action" id="pin-clear">EFFACER</div>
        <div class="pin-key" data-digit="0">0</div>
        <div class="pin-key action" id="pin-validate">VALIDER</div>
      </div>

      <div class="pin-footer">
        <span>Acc√®s selon <strong>role</strong> dans la table <strong>users</strong>.</span>
        <span><strong>Punk Noodles</strong></span>
      </div>
    </div>
  </div>

  <!-- HEADER (apr√®s login) -->
  <header id="main-header" class="hidden">
    <div class="title-block">
      <h1>Punk Noodles ‚Äî Back Office</h1>
      <span id="header-subtitle">Connect√©</span>
    </div>

    <div class="user-info-bar">
      <span id="header-period" class="badge-soft hidden"></span>
      <span id="header-username"></span>
      <span id="header-role" class="role-badge"></span>
      <button class="btn-secondary btn-sm" id="btn-logout">D√©connexion</button>
      <button class="btn-secondary btn-sm" id="btn-article">Article</button>
    </div>
  </header>

  <main>
    <section class="recrutement-card">
      <h1 class="recrutement-title">Punk Noodles</h1>
      <h2 class="recrutement-subtitle">Organisation ‚Ä¢ Ventes ‚Ä¢ Runs ‚Ä¢ Tombola (Tambourin)</h2>
    </section>

    <!-- ü•Å TOMBOLA -->
    <section id="tombola-section" class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Tambourin (Tombola)</div>
          <div class="card-subtitle">Plus quelqu‚Äôun ach√®te, plus il a de tickets ‚Üí plus de chances de gagner.</div>
        </div>
        <div class="stat-pill">Tickets total: <span id="tombola-total-tickets">0</span></div>
      </div>

      <div class="tombola-wrap">
        <div class="drum" id="drum">
          <div class="drum-head">
            <div>
              <div class="drum-title">Tirage pond√©r√©</div>
              <div class="drum-sub">
                Chaque <strong>produit achet√© = 1 ticket</strong>.<br/>
                Tirage au sort bas√© sur le total de tickets.
              </div>
            </div>
            <div class="tag" id="tombola-mode-tag">Lecture</div>
          </div>

          <div class="drum-visual">
            <div class="drum-circle">
              <div class="drum-badge">PUNK ‚Ä¢ NOODLES</div>
            </div>
          </div>

          <div class="field-row" id="tombola-admin-form" style="margin-top:10px;">
            <div class="field-group">
              <label>Nom / Pseudo</label>
              <input id="tombola-name" type="text" placeholder="Ex: Rico" />
            </div>
            <div class="field-group">
              <label>Contact (optionnel)</label>
              <input id="tombola-contact" type="text" placeholder="Ex: +32..." />
            </div>
            <div class="field-group">
              <label>Produits achet√©s</label>
              <input id="tombola-products" type="number" min="1" value="1" />
            </div>
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:6px;">
            <button class="btn" id="btn-tombola-add" style="display:none;">Inscrire</button>
            <button class="btn-secondary btn-sm" id="btn-tombola-refresh">Rafra√Æchir</button>
            <button class="btn" id="btn-tombola-draw" style="display:none;">TIRER AU SORT</button>
          </div>

          <div class="winner-box">
            <div class="winner-label">Dernier gagnant</div>
            <div class="winner-name" id="tombola-winner-name">‚Äî</div>
            <div class="winner-meta" id="tombola-winner-meta">‚Äî</div>
          </div>

          <div class="separator"></div>

          <div class="card-title" style="margin-bottom:6px;">Historique des tirages</div>
          <div class="mini-list" id="tombola-draws"></div>
        </div>

        <div>
          <div class="card-title">Participants</div>
          <div class="card-subtitle">Tickets = produits achet√©s.</div>
          <div class="runs-list" id="tombola-participants" style="max-height:420px;"></div>
        </div>
      </div>
    </section>

    <!-- üèéÔ∏è VOITURES -->
    <section id="cars-section" class="card" style="margin-top:22px;">
      <div class="card-header">
        <div>
          <div class="card-title">V√©hicules disponibles</div>
          <div class="card-subtitle">Liste des voitures & √©tat (disponible / prise).</div>
        </div>
      </div>
      <div id="cars-list" class="runs-list"></div>
    </section>

    <!-- SECTION UTILISATEUR -->
    <section id="user-section" class="hidden" style="margin-top:22px;">
      <div class="grid">
        <!-- FICHE UTILISATEUR -->
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Ma fiche</div>
              <div class="card-subtitle">R√©sum√© de ton activit√© et info compte.</div>
            </div>
          </div>

          <div class="field-group">
            <label>Nom / Pseudo</label>
            <div id="user-name" class="text-sm"></div>
          </div>

          <div class="field-row">
            <div class="field-group">
              <label>Code PIN</label>
              <div id="user-pin" class="text-sm muted"></div>
            </div>
            <div class="field-group">
              <label>Date de cr√©ation</label>
              <div id="user-created" class="text-sm muted"></div>
            </div>
          </div>

          <div class="separator"></div>

          <div class="stats-row">
            <div class="stat-card">
              <div class="stat-label">Nombre de runs</div>
              <div id="user-runs-count" class="stat-value">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Photos envoy√©es</div>
              <div id="user-photos-count" class="stat-value">0</div>
            </div>
          </div>

          <div id="runner-weekly-panel" class="hidden">
            <div class="separator"></div>
            <div class="card-title" style="margin-bottom:6px;">Prime & grade (semaine)</div>
            <div class="stats-row" style="margin-top:6px;">
              <div class="stat-card">
                <div class="stat-label">Runs (7 derniers jours)</div>
                <div id="user-weekly-runs" class="stat-value">0</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Grade semaine</div>
                <div id="user-weekly-grade" class="stat-value">‚Äî</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Prime semaine</div>
                <div id="user-weekly-bonus" class="stat-value">$0.00</div>
              </div>
            </div>
<p class="text-xs muted" style="margin-top:6px;">
  R√®gle: <strong>&ge; 4 runs</strong> = Silver I ‚Ä¢ <strong>&ge; 6 runs</strong> = Silver II (depuis la r√©initialisation).
</p>
          </div>

          <div id="vendor-commission-panel" class="hidden">
            <div class="separator"></div>
            <div class="card-title" style="margin-bottom:6px;">Gains vendeur</div>
            <div class="stats-row" style="margin-top:6px;">
              <div class="stat-card">
                <div class="stat-label">Commission</div>
                <div id="user-commission-percent" class="stat-value">0%</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Ventes ($ re√ßus)</div>
                <div id="user-vendor-ventes-sum" class="stat-value">$0.00</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Gain</div>
                <div id="user-commission-earnings" class="stat-value">$0.00</div>
              </div>
            </div>
            <p class="text-xs muted" style="margin-top:6px;">Gain = ventes √ó commission (%). La commission se r√®gle c√¥t√© Admin.</p>
          </div>
        </div>

        <!-- NOUVEAU RUN -->
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Ajouter un run</div>
              <div class="card-subtitle">D√©clare un nouveau run + $ re√ßus.</div>
            </div>
          </div>

          <div class="field-group">
            <label>Description du run</label>
            <textarea id="run-description" rows="3" placeholder="Ex: Run du soir, zone est, contr√¥le de stock..."></textarea>
          </div>

          <div class="field-row">
            <div class="field-group">
              <label>Ce qui a √©t√© vendu (description)</label>
              <input id="run-sales-desc" type="text" placeholder="Ex: 3 packs, 2 bo√Ætes..." />
            </div>
            <div class="field-group">
              <label>Montant total ($ re√ßus)</label>
              <input id="run-sales-amount" type="number" step="0.01" min="0" placeholder="Ex: 250" />
            </div>
          </div>

          <!-- ‚úÖ RUN PHOTO: 1 min / 2 max -->
          <div class="field-group">
            <label>Photos du run (OBLIGATOIRE ‚Ä¢ 1 √† 2)</label>
            <input type="file" id="run-photo" accept="image/*" multiple />
            <div class="text-xs muted" style="margin-top:4px;">Minimum 1 photo, maximum 2. (preuve / stock / produits)</div>
          </div>

          <button class="btn" id="btn-add-run">Enregistrer le run + Photos</button>
        </div>
      </div>

      <!-- PANEL VENDEUR -->
      <div id="vendeur-panel" class="card hidden" style="margin-top:20px;">
        <div class="card-header">
          <div>
            <div class="card-title">Ajouter une vente</div>
            <div class="card-subtitle">Encode ce que tu as vendu + $ re√ßus + photo</div>
          </div>
        </div>

        <div class="field-group">
          <label>Description</label>
          <input type="text" id="vente-desc" placeholder="Ex : 3 bo√Ætes, 1 pack..." />
        </div>

        <div class="field-row">
          <div class="field-group">
            <label>Quantit√©</label>
            <input type="number" id="vente-qty" value="1" min="1" />
          </div>

          <div class="field-group">
            <label>Montant ($ re√ßus)</label>
            <input type="number" id="vente-price" placeholder="Ex : 150" />
          </div>
        </div>

        <div class="field-group">
          <label>Photo (optionnel)</label>
          <input type="file" id="vente-photo" accept="image/*" />
        </div>

        <button class="btn" id="btn-add-vente">Enregistrer la vente</button>
      </div>

      <!-- LISTE DES VENTES (vendeur) -->
      <div id="liste-ventes" class="card hidden" style="margin-top:20px;">
        <div class="card-header">
          <div>
            <div class="card-title">Mes ventes</div>
            <div class="card-subtitle">Historique de tout ce que tu as vendu</div>
          </div>
        </div>
        <div id="ventes-list" class="runs-list"></div>
      </div>

      <!-- üí∏ COMPTABILIT√â (UTILISATEUR) -->
      <div class="card" style="margin-top:20px;">
        <div class="card-header">
          <div>
            <div class="card-title">Comptabilit√©</div>
            <div class="card-subtitle">Note tes achats (mati√®re premi√®re) + d√©penses. Calcul automatique du chiffre d‚Äôaffaires.</div>
          </div>
          <div class="stat-pill">CA: <span id="user-ca-sum">$0.00</span></div>
        </div>

        <div class="stats-row" style="margin-top:6px;">
          <div class="stat-card">
            <div class="stat-label">Runs ($ re√ßus)</div>
            <div id="user-runs-sum" class="stat-value">$0.00</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Ventes ($ re√ßus)</div>
            <div id="user-ventes-sum" class="stat-value">$0.00</div>
          </div>
        </div>

        <div class="stats-row" style="margin-top:6px;">
          <div class="stat-card">
            <div class="stat-label">Achats mati√®re premi√®re</div>
            <div id="user-purchases-sum" class="stat-value">$0.00</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">R√©sultat brut (CA - achats)</div>
            <div id="user-gross-sum" class="stat-value">$0.00</div>
          </div>
        </div>

        <div class="separator"></div>

        <div class="field-row">
          <div class="field-group">
            <label>Type</label>
            <select id="txu-type">
              <option value="purchase">Achat (mati√®re premi√®re)</option>
              <option value="expense">D√©pense</option>
            </select>
          </div>
          <div class="field-group">
            <label>Cat√©gorie</label>
            <select id="txu-category">
              <option value="matiere_premiere">Mati√®re premi√®re</option>
              <option value="loyer">Loyer</option>
              <option value="essence">Essence</option>
              <option value="salaire">Salaire</option>
              <option value="autre">Autre</option>
            </select>
          </div>
        </div>

        <div class="field-row">
          <div class="field-group">
            <label>Description</label>
            <input id="txu-desc" type="text" placeholder="Ex: Farine, Nouilles, emballage..." />
          </div>
          <div class="field-group">
            <label>Montant ($)</label>
            <input id="txu-amount" type="number" step="0.01" min="0" placeholder="Ex: 120" />
          </div>
        </div>

        <div class="field-group">
          <label>Photo (optionnel)</label>
          <input type="file" id="txu-photo" accept="image/*" />
        </div>

        <button class="btn" id="btn-add-txu">Enregistrer</button>
        <p class="text-xs muted" style="margin-top:6px;">Le CA = total des $ re√ßus (ventes + runs). Le r√©sultat brut = CA - achats mati√®re premi√®re.</p>

        <div class="separator"></div>

        <div class="card-title" style="margin-bottom:6px;">Historique (mes achats & d√©penses)</div>
        <div id="user-transactions-list" class="runs-list"></div>
      </div>

      <!-- LISTE DES RUNS -->
      <div class="card" style="margin-top: 22px;">
        <div class="card-header">
          <div>
            <div class="card-title">Mes runs</div>
            <div class="card-subtitle">Historique des runs + photos associ√©es.</div>
          </div>
          <div class="stat-pill">Total runs: <span id="user-runs-count-pill">0</span></div>
        </div>
        <div id="user-runs-list" class="runs-list"></div>
      </div>
    </section>

    <!-- SECTION ADMIN -->
    <section id="admin-section" class="hidden" style="margin-top:22px;">
      <div class="admin-grid">
        <!-- Stats -->
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Dashboard Admin</div>
              <div class="card-subtitle">Vue d'ensemble des comptes & activit√© (p√©riode semaine).</div>
            </div>
            <span class="badge-soft">Mode Admin</span>
          </div>

          <div class="stats-row">
            <div class="stat-card">
              <div class="stat-label">Utilisateurs</div>
              <div id="admin-users-count" class="stat-value">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Total runs</div>
              <div id="admin-runs-count" class="stat-value">0</div>
            </div>
          </div>

          <div class="stats-row" style="margin-top: 12px;">
            <div class="stat-card">
              <div class="stat-label">Photos enregistr√©es</div>
              <div id="admin-photos-count" class="stat-value">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Runs ($ re√ßus)</div>
              <div id="admin-runs-sum" class="stat-value">$0.00</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Ventes ($ re√ßus)</div>
              <div id="admin-ventes-sum" class="stat-value">$0.00</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Total CA ($ re√ßus)</div>
              <div id="admin-sales-sum" class="stat-value">$0.00</div>
            </div>
          </div>

          <div class="stats-row" style="margin-top: 12px;">
            <div class="stat-card">
              <div class="stat-label">Achats mati√®re premi√®re</div>
              <div id="admin-purchases-sum" class="stat-value">$0.00</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">R√©sultat brut (CA - achats)</div>
              <div id="admin-gross-sum" class="stat-value">$0.00</div>
            </div>
          </div>

          <p class="text-xs muted" style="margin-top: 10px;">
            CA = somme des <strong>ventes</strong> + <strong>runs</strong> ($ re√ßus) depuis <strong>week_start</strong>.
          </p>
        </div>

        <!-- Gestion comptes -->
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Gestion des comptes</div>
              <div class="card-subtitle">Cr√©e ou modifie un utilisateur (Code PIN).</div>
            </div>
          </div>

          <div class="field-row">
            <div class="field-group">
              <label>Nom / Pseudo</label>
              <input id="admin-user-name" type="text" placeholder="Ex: Logan, Rico..." />
            </div>
            <div class="field-group">
              <label>Code PIN (4 chiffres)</label>
              <input id="admin-user-pin" type="text" maxlength="4" placeholder="Ex: 6554" />
            </div>
          </div>

          <div class="field-row">
            <div class="field-group">
              <label>R√¥le</label>
              <select id="admin-user-role">
                <option value="user">Utilisateur</option>
                <option value="admin">Admin</option>
                <option value="runner">Runner</option>
                <option value="vendeur">Vendeur</option>
              </select>
            </div>
          </div>

          <div class="field-row" id="vendor-commission-row" style="display:none;">
            <div class="field-group">
              <label>Commission vendeur (%)</label>
              <input id="admin-user-commission" type="number" step="0.01" min="0" max="100" placeholder="Ex: 15" />
            </div>
          </div>

          <div style="margin-top: 8px; display: flex; gap: 8px; flex-wrap:wrap;">
            <button class="btn" id="btn-admin-save-user">Sauvegarder / Cr√©er</button>
            <button class="btn-danger btn-sm hidden" id="btn-admin-delete-user">Supprimer l'utilisateur</button>
          </div>

          <p class="text-xs muted" style="margin-top: 6px;">
            Clique sur un utilisateur dans la liste pour le charger ici.
          </p>
        </div>
      </div>

      <!-- ‚úÖ FIN DE SEMAINE / PDF -->
      <div class="card" style="margin-top:22px;">
        <div class="card-header">
          <div>
            <div class="card-title">Fin de semaine</div>
            <div class="card-subtitle">Exporter le PDF + r√©initialiser la p√©riode (sans supprimer l‚Äôhistorique).</div>
          </div>
          <span class="badge-soft" id="admin-week-range">‚Äî</span>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn" id="btn-export-week-pdf">Exporter PDF semaine</button>
          <button class="btn-danger btn-sm" id="btn-close-week">Cl√¥turer / R√©initialiser la semaine</button>
          <button class="btn-secondary btn-sm" id="btn-refresh-reports">Rafra√Æchir rapports</button>
        </div>

        <div class="separator"></div>
        <div class="card-title" style="margin-bottom:6px;">Rapports enregistr√©s</div>
        <div id="admin-reports-list" class="runs-list" style="max-height:260px;"></div>

        <p class="text-xs muted" style="margin-top:10px;">
          Le PDF est aussi upload dans Storage bucket <strong>weekly-reports</strong> et enregistr√© dans table <strong>weekly_reports</strong>.
        </p>
      </div>

      <!-- üí∏ COMPTABILIT√â (ADMIN) -->
      <div class="card" style="margin-top: 22px;">
        <div class="card-header">
          <div>
            <div class="card-title">Comptabilit√© ‚Äî Achats & D√©penses</div>
            <div class="card-subtitle">Ajoute les achats (mati√®re premi√®re) + d√©penses de l‚Äôentreprise.</div>
          </div>
          <span class="badge-soft">Entreprise</span>
        </div>

        <div class="field-row">
          <div class="field-group">
            <label>Type</label>
            <select id="txa-type">
              <option value="purchase">Achat (mati√®re premi√®re)</option>
              <option value="expense">D√©pense</option>
            </select>
          </div>
          <div class="field-group">
            <label>Cat√©gorie</label>
            <select id="txa-category">
              <option value="matiere_premiere">Mati√®re premi√®re</option>
              <option value="loyer">Loyer</option>
              <option value="essence">Essence</option>
              <option value="salaire">Salaire</option>
              <option value="autre">Autre</option>
            </select>
          </div>
        </div>

        <div class="field-row">
          <div class="field-group">
            <label>Description</label>
            <input id="txa-desc" type="text" placeholder="Ex: Nouilles, √©pices, cartons..." />
          </div>
          <div class="field-group">
            <label>Montant ($)</label>
            <input id="txa-amount" type="number" step="0.01" min="0" placeholder="Ex: 250" />
          </div>
        </div>

        <div class="field-group">
          <label>Photo (optionnel)</label>
          <input type="file" id="txa-photo" accept="image/*" />
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
          <button class="btn" id="btn-add-txa">Enregistrer</button>
          <button class="btn-secondary btn-sm" id="btn-refresh-txa">Rafra√Æchir</button>
        </div>

        <div class="separator"></div>

        <div class="card-title" style="margin-bottom:6px;">Historique (entreprise)</div>
        <div id="admin-transactions-list" class="runs-list" style="max-height:360px;"></div>
      </div>

      <!-- Users + d√©tails -->
      <div class="card" style="margin-top: 22px;">
        <div class="card-header">
          <div>
            <div class="card-title">Utilisateurs & activit√©</div>
            <div class="card-subtitle">Clique sur un utilisateur pour voir ses runs & stats (p√©riode semaine).</div>
          </div>
        </div>

        <div style="display:grid; grid-template-columns: 1.1fr 1.3fr; gap:20px;">
          <div>
            <table class="table" id="admin-users-table">
              <thead>
                <tr>
                  <th>Nom</th>
                  <th>PIN</th>
                  <th>R√¥le</th>
                  <th>Runs</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div>
            <div class="field-group">
              <label>Utilisateur s√©lectionn√©</label>
              <div id="admin-selected-user" class="text-sm muted">Aucun utilisateur s√©lectionn√©.</div>
            </div>
            <div class="separator"></div>
            <div id="admin-selected-runs" class="runs-list" style="max-height:260px;"></div>
          </div>
        </div>
      </div>

      <!-- üèÖ RUNNERS ‚Äî PRIMES SEMAINE -->
      <div class="card" style="margin-top: 22px;">
        <div class="card-header">
          <div>
            <div class="card-title">Runners ‚Äî primes & grades</div>
<div class="card-subtitle">Calcul sur la p√©riode (depuis week_start) : prime si &ge;4 runs / &ge;6 runs.</div>
          </div>
          <button class="btn-secondary btn-sm" id="btn-refresh-bonus">Rafra√Æchir</button>
        </div>

        <div style="max-height: 360px; overflow:auto;">
          <table class="table" id="admin-runners-bonus-table">
            <thead>
              <tr>
                <th>Runner</th>
                <th>Runs (7j)</th>
                <th>Grade</th>
                <th>Prime</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <p class="text-xs muted" style="margin-top: 10px;">
          Par d√©faut la prime est √† $0.00 (modifiable dans le code JS).
        </p>
      </div>

      <!-- üí∞ VENDEURS ‚Äî COMMISSIONS -->
      <div class="card" style="margin-top: 22px;">
        <div class="card-header">
          <div>
            <div class="card-title">Vendeurs ‚Äî commissions</div>
            <div class="card-subtitle">Calcul automatique: ventes √ó commission (%)</div>
          </div>
          <button class="btn-secondary btn-sm" id="btn-refresh-commissions">Rafra√Æchir</button>
        </div>

        <div style="max-height: 360px; overflow:auto;">
          <table class="table" id="admin-vendors-commission-table">
            <thead>
              <tr>
                <th>Vendeur</th>
                <th>Commission</th>
                <th>Ventes ($ re√ßus)</th>
                <th>Gain</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- VENTES admin -->
      <div class="card" style="margin-top: 22px;">
        <div class="card-header">
          <div>
            <div class="card-title">Ventes (tous vendeurs)</div>
            <div class="card-subtitle">Vue globale des ventes enregistr√©es (p√©riode semaine).</div>
          </div>
        </div>

        <div style="max-height: 360px; overflow:auto;">
          <table class="table" id="admin-ventes-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Vendeur</th>
                <th>Description</th>
                <th>Qt√©</th>
                <th>$ re√ßus</th>
                <th>Date</th>
                <th>Photo</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ‚öôÔ∏è CONFIG SUPABASE
    const SUPABASE_URL = "https://ldhxyloqdtplevdkgnah.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkaHh5bG9xZHRwbGV2ZGtnbmFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyMTg5NjAsImV4cCI6MjA3Njc5NDk2MH0.pnoppZtVEP3uDrMEfauPAMMB93EmGO5Ur1pg4OY99-o";
    const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // √âtat global
    let currentUser = null;
    let currentRole = null; // 'user' | 'admin' | 'runner' | 'vendeur'
    let adminSelectedUserId = null;
    let adminUsersCache = {};

    // PIN
    let pinValue = "";

    // ‚úÖ SEMAINE (p√©riode) stock√©e en base
    let WEEK_START_ISO = null; // ex: "2025-12-16T00:00:00.000Z"
    function fmtUSD(value){
      const n = Number(value || 0);
      try {
        return new Intl.NumberFormat("en-US", { style:"currency", currency:"USD" }).format(n);
      } catch (e) {
        return "$" + n.toFixed(2);
      }
    }
    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function toFr(dt){
      try { return new Date(dt).toLocaleString("fr-FR"); } catch(e){ return String(dt); }
    }
    function getDefaultWeekStartISO(){
      // Lundi 00:00 local
      const now = new Date();
      const d = new Date(now);
      const day = d.getDay(); // 0 dimanche.. 1 lundi..
      const diff = (day === 0 ? 6 : day - 1);
      d.setDate(d.getDate() - diff);
      d.setHours(0,0,0,0);
      return d.toISOString();
    }
    async function loadWeekStart(){
      const fallback = getDefaultWeekStartISO();
      try{
        const { data, error } = await supa.from("app_settings").select("*").eq("key","week_start").maybeSingle();
        if (error) {
          console.error(error);
          WEEK_START_ISO = fallback;
          return;
        }
        if (!data) {
          const ins = await supa.from("app_settings").insert({ key:"week_start", value:fallback });
          if (ins.error) console.error(ins.error);
          WEEK_START_ISO = fallback;
          return;
        }
        WEEK_START_ISO = data.value || fallback;
      } catch(e){
        console.error(e);
        WEEK_START_ISO = fallback;
      }
    }
    function sinceISO(){
      return WEEK_START_ISO || getDefaultWeekStartISO();
    }
    function updateHeaderPeriod(){
      const el = document.getElementById("header-period");
      if (!el) return;
      if (!WEEK_START_ISO) { el.classList.add("hidden"); return; }
      el.classList.remove("hidden");
      el.textContent = "P√©riode: " + new Date(WEEK_START_ISO).toLocaleDateString("fr-FR");
      const adminRange = document.getElementById("admin-week-range");
      if (adminRange) adminRange.textContent = "Depuis " + new Date(WEEK_START_ISO).toLocaleDateString("fr-FR");
    }

    // üíé R√àGLES "GRADE / PRIME" RUNNER (7 derniers jours)
    const BONUS_TIER1_RUNS = 4;
    const BONUS_TIER2_RUNS = 6;
    const BONUS_TIER1_AMOUNT = 30000;
    const BONUS_TIER2_AMOUNT = 40000;

    function updatePinDots() {
      for (let i = 0; i < 4; i++) {
        const dot = document.getElementById("pin-dot-" + i);
        if (!dot) continue;
        if (i < pinValue.length) {
          dot.classList.add("filled");
          dot.textContent = "‚Ä¢";
        } else {
          dot.classList.remove("filled");
          dot.textContent = "";
        }
      }
    }
    function setPinStatus(message, isError = false) {
      const el = document.getElementById("pin-status");
      if (!el) return;
      el.textContent = message;
      if (isError) el.classList.add("pin-status-error");
      else el.classList.remove("pin-status-error");
    }
    function appendDigit(digit) {
      if (pinValue.length >= 4) return;
      pinValue += digit;
      updatePinDots();
    }
    function clearPin() {
      pinValue = "";
      updatePinDots();
      setPinStatus("Codes g√©r√©s c√¥t√© base de donn√©es (Supabase).", false);
    }

    async function validatePin() {
      if (pinValue.length !== 4) {
        setPinStatus("Le Code PIN doit contenir 4 chiffres.", true);
        return;
      }
      setPinStatus("V√©rification du Code PIN...", false);

      try {
        const { data, error } = await supa
          .from("users")
          .select("*")
          .eq("pin_code", pinValue)
          .maybeSingle();

        if (error) {
          console.error(error);
          setPinStatus("Erreur de connexion √† la base. V√©rifie Supabase.", true);
          return;
        }
        if (!data) {
          setPinStatus("Code PIN incorrect ou inconnu.", true);
          clearPin();
          return;
        }

        currentUser = data;
        currentRole = data.role || "user";

        // ‚úÖ charge week_start
        await loadWeekStart();
        updateHeaderPeriod();

        document.getElementById("pin-overlay").classList.add("hidden");
        document.getElementById("main-header").classList.remove("hidden");

        document.getElementById("header-username").textContent =
          data.username || ("Utilisateur #" + data.id);

        let roleLabel;
        switch (currentRole) {
          case "admin": roleLabel = "Admin"; break;
          case "runner": roleLabel = "Runner"; break;
          case "vendeur": roleLabel = "Vendeur"; break;
          default: roleLabel = "Utilisateur";
        }
        document.getElementById("header-role").textContent = roleLabel;

        document.getElementById("header-subtitle").textContent =
          currentRole === "admin" ? "Connect√© en mode administrateur." : "Connect√© sur ta fiche personnelle.";

        setupTombolaMode();

        if (currentRole === "admin") {
          document.getElementById("admin-section").classList.remove("hidden");
          document.getElementById("user-section").classList.add("hidden");
          await loadAdminDashboard();
          await loadCars();
          await loadAdminTransactions();
          await loadReports();
        } else {
          document.getElementById("user-section").classList.remove("hidden");
          document.getElementById("admin-section").classList.add("hidden");
          await loadUserDashboard();

          if (currentRole === "vendeur") {
            document.getElementById("vendeur-panel").classList.remove("hidden");
            document.getElementById("liste-ventes").classList.remove("hidden");
            await loadVentes();
          } else {
            document.getElementById("vendeur-panel").classList.add("hidden");
            document.getElementById("liste-ventes").classList.add("hidden");
          }

          await loadCars();
          await loadUserTransactions();
          await refreshUserFinance();
        }

        await loadTombola();

      } catch (err) {
        console.error(err);
        setPinStatus("Erreur inconnue. Regarde la console.", true);
      }
    }

    function setupPinPad() {
      document.querySelectorAll(".pin-key[data-digit]").forEach((btn) => {
        btn.addEventListener("click", () => appendDigit(btn.dataset.digit));
      });
      document.getElementById("pin-clear")?.addEventListener("click", clearPin);
      document.getElementById("pin-validate")?.addEventListener("click", validatePin);
    }

    // ---------------------------------------
    // üèéÔ∏è VOITURES
    // ---------------------------------------
    async function loadCars() {
      if (!currentUser) return;

      const { data: cars, error } = await supa.from("cars").select("*").order("id", { ascending: true });
      if (error) { console.error(error); return; }

      const list = document.getElementById("cars-list");
      list.innerHTML = "";

      if (!cars || cars.length === 0) {
        list.innerHTML = "<div class='text-sm muted'>Aucune voiture enregistr√©e.</div>";
        return;
      }

      cars.forEach((car) => {
        const isTaken = car.is_taken;
        const statusText = isTaken ? ("Pris par utilisateur #" + car.taken_by) : "Disponible";
        const statusClass = isTaken ? "car-taken" : "car-free";
        const btnLabel = isTaken ? (car.taken_by === currentUser.id ? "Lib√©rer" : "Indisponible") : "Prendre";
        const disabled = isTaken && car.taken_by !== currentUser.id;

        const div = document.createElement("div");
        div.className = "car-item";
        div.innerHTML = `
          <div>
            <strong>${escapeHtml(car.name)}</strong><br>
            <span class="car-status ${statusClass}">${escapeHtml(statusText)}</span>
          </div>
          <button class="car-btn" data-id="${car.id}" ${disabled ? "disabled" : ""}>${escapeHtml(btnLabel)}</button>
        `;
        list.appendChild(div);
      });

      document.querySelectorAll(".car-btn").forEach((btn) => {
        btn.addEventListener("click", async () => {
          const carId = btn.dataset.id;
          const { data: carData, error: carErr } = await supa.from("cars").select("*").eq("id", carId).maybeSingle();
          if (carErr || !carData) { console.error(carErr); return; }

          if (!carData.is_taken) {
            const { error: updErr } = await supa.from("cars").update({ is_taken: true, taken_by: currentUser.id }).eq("id", carData.id);
            if (updErr) console.error(updErr);
          } else if (carData.taken_by === currentUser.id) {
            const { error: updErr } = await supa.from("cars").update({ is_taken: false, taken_by: null }).eq("id", carData.id);
            if (updErr) console.error(updErr);
          }
          await loadCars();
        });
      });
    }

    async function releaseAllCars(){
      const { error } = await supa.from("cars").update({ is_taken:false, taken_by:null }).neq("id", -1);
      if (error) console.error(error);
    }

    // ---------------------------------------
    // UTILISATEUR
    // ---------------------------------------
    async function loadUserDashboard() {
      if (!currentUser) return;

      document.getElementById("user-name").textContent = currentUser.username || ("Utilisateur #" + currentUser.id);
      document.getElementById("user-pin").textContent = currentUser.pin_code;
      document.getElementById("user-created").textContent =
        currentUser.created_at ? new Date(currentUser.created_at).toLocaleString("fr-FR") : "-";

      await refreshUserRunsAndPhotos();
    }

    // ‚úÖ photos max par run
    const MAX_RUN_PHOTOS = 2;

    async function refreshUserRunsAndPhotos() {
      if (!currentUser) return;

      const { data: runs, error: runsError } = await supa
        .from("runs")
        .select("id, description, sales_description, sales_amount, created_at, photos:photos(url)")
        .eq("user_id", currentUser.id)
        .gte("created_at", sinceISO())
        .order("created_at", { ascending: false });

      if (runsError) { console.error(runsError); return; }

      const runsListEl = document.getElementById("user-runs-list");
      runsListEl.innerHTML = "";

      let totalPhotos = 0;

      if (runs && runs.length > 0) {
        runs.forEach((run) => {
          const createdAt = run.created_at ? new Date(run.created_at).toLocaleString("fr-FR") : "-";
          const salesDesc = run.sales_description || "";
          const salesAmount = run.sales_amount || 0;
          const photos = run.photos || [];
          totalPhotos += photos.length;

          const runEl = document.createElement("div");
          runEl.className = "run-item";
          runEl.innerHTML = `
            <div class="run-header">
              <div><strong>Run #${run.id}</strong></div>
              <div class="run-date">${escapeHtml(createdAt)}</div>
            </div>
            <div class="run-description">${escapeHtml(run.description || "")}</div>
            ${(salesDesc || salesAmount) ? `
              <div class="run-sales">
                $ re√ßus: ${salesDesc ? escapeHtml(salesDesc) + " ‚Äî " : ""}${salesAmount ? fmtUSD(salesAmount) : ""}
              </div>` : ""
            }
            <div class="run-photo-zone">
              <span class="badge-soft">Photos: ${photos.length}/${MAX_RUN_PHOTOS}</span>
              <input type="file" class="photo-input" data-run-id="${run.id}" accept="image/*" multiple />
              <button class="btn btn-sm btn-secondary btn-upload-photo" data-run-id="${run.id}">Uploader</button>
            </div>
            ${photos.length ? `
              <div class="photos-preview">
                ${photos.map(p => `<img src="${p.url}" alt="photo run ${run.id}" />`).join("")}
              </div>` : ""
            }
          `;
          runsListEl.appendChild(runEl);
        });
      } else {
        runsListEl.innerHTML = "<div class='text-sm muted'>Aucun run pour la p√©riode.</div>";
      }

      const runsCount = runs ? runs.length : 0;
      document.getElementById("user-runs-count").textContent = runsCount;
      document.getElementById("user-runs-count-pill").textContent = runsCount;
      document.getElementById("user-photos-count").textContent = totalPhotos;

      document.querySelectorAll(".btn-upload-photo").forEach((btn) => {
        btn.addEventListener("click", async () => {
          const runId = btn.dataset.runId;
          await uploadPhotosForRun(runId, currentUser.id);
          await refreshUserRunsAndPhotos();
        });
      });
    }

    async function countRunPhotos(runId){
      const { data, error } = await supa.from("photos").select("id").eq("run_id", runId);
      if (error) { console.error(error); return 0; }
      return (data || []).length;
    }

    async function uploadPhotosForRun(runId, userId) {
      const input = document.querySelector(`.photo-input[data-run-id="${runId}"]`);
      if (!input || !input.files || input.files.length === 0) {
        alert("S√©lectionne 1 ou 2 images avant d'uploader.");
        return;
      }
      if (input.files.length > MAX_RUN_PHOTOS) {
        alert("Maximum 2 photos par upload.");
        return;
      }

      const existing = await countRunPhotos(runId);
      if (existing >= MAX_RUN_PHOTOS) {
        alert("Ce run a d√©j√† 2 photos. Impossible d'en ajouter plus.");
        input.value = "";
        return;
      }
      if (existing + input.files.length > MAX_RUN_PHOTOS) {
        alert(`Il reste ${MAX_RUN_PHOTOS - existing} place(s) photo. Trop d'images s√©lectionn√©es.`);
        return;
      }

      try {
        for (const file of Array.from(input.files)) {
          const filenameSafe = file.name.replace(/[^a-zA-Z0-9.\-_]/g, "_");
          const filePath = `${userId}/${runId}/${Date.now()}_${filenameSafe}`;

          const { error } = await supa.storage.from("runs-photos").upload(filePath, file);
          if (error) { console.error(error); alert("Erreur upload image."); return; }

          const { data: publicUrlData, error: publicUrlError } = supa.storage.from("runs-photos").getPublicUrl(filePath);
          if (publicUrlError) { console.error(publicUrlError); alert("Erreur URL publique."); return; }

          const { error: insertError } = await supa.from("photos").insert({ run_id: runId, user_id: userId, url: publicUrlData.publicUrl });
          if (insertError) { console.error(insertError); alert("Erreur enregistrement photo en base."); return; }
        }
        input.value = "";
      } catch (err) {
        console.error(err);
        alert("Erreur inattendue pendant l'upload.");
      }
    }

    async function addRun() {
      if (!currentUser) return;

      const descEl = document.getElementById("run-description");
      const salesDescEl = document.getElementById("run-sales-desc");
      const salesAmountEl = document.getElementById("run-sales-amount");
      const photoInput = document.getElementById("run-photo");

      const description = descEl.value.trim();
      const salesDesc = salesDescEl.value.trim();
      const salesAmount = parseFloat(salesAmountEl.value || "0") || 0;

      if (!description) { alert("Merci de remplir au minimum la description du run."); return; }

      // ‚úÖ 1 photo min / 2 max
      if (!photoInput || !photoInput.files || photoInput.files.length < 1) {
        alert("Minimum 1 photo obligatoire pour cr√©er le run.");
        return;
      }
      if (photoInput.files.length > MAX_RUN_PHOTOS) {
        alert("Maximum 2 photos pour cr√©er le run.");
        return;
      }

      const { data: runInsert, error: runError } = await supa
        .from("runs")
        .insert({ user_id: currentUser.id, description, sales_description: salesDesc || null, sales_amount: salesAmount || null })
        .select()
        .maybeSingle();

      if (runError || !runInsert) { console.error(runError); alert("Erreur enregistrement du run."); return; }

      const runId = runInsert.id;

      // upload 1..2 photos
      try{
        for (const file of Array.from(photoInput.files)) {
          const filenameSafe = file.name.replace(/[^a-zA-Z0-9.\-_]/g, "_");
          const filePath = `${currentUser.id}/${runId}/${Date.now()}_${filenameSafe}`;

          const { error: uploadError } = await supa.storage.from("runs-photos").upload(filePath, file);
          if (uploadError) { console.error(uploadError); alert("Erreur upload image."); return; }

          const { data: urlData } = supa.storage.from("runs-photos").getPublicUrl(filePath);
          const { error: photoError } = await supa.from("photos").insert({ run_id: runId, user_id: currentUser.id, url: urlData.publicUrl });
          if (photoError) { console.error(photoError); alert("Erreur enregistrement photo."); return; }
        }
      } catch(e){
        console.error(e);
        alert("Erreur upload des photos.");
        return;
      }

      descEl.value = ""; salesDescEl.value = ""; salesAmountEl.value = ""; photoInput.value = "";
      await refreshUserRunsAndPhotos();
      await refreshUserFinance();
    }

    // ---------------------------------------
    // VENTES (VENDEUR)
    // ---------------------------------------
    async function addVente() {
      if (!currentUser) return;

      const desc = document.getElementById("vente-desc").value.trim();
      const qty = parseInt(document.getElementById("vente-qty").value || "1");
      const price = parseFloat(document.getElementById("vente-price").value || "0");
      const photoInput = document.getElementById("vente-photo");

      if (!desc || !price) { alert("Description et montant obligatoires."); return; }

      let photoUrl = null;
      if (photoInput.files.length > 0) {
        const file = photoInput.files[0];
        const safeName = file.name.replace(/[^a-zA-Z0-9.\-_]/g, "_");
        const filePath = `${currentUser.id}/ventes/${Date.now()}_${safeName}`;

        const { error: uploadError } = await supa.storage.from("runs-photos").upload(filePath, file);
        if (uploadError) { console.error(uploadError); alert("Erreur upload photo vente."); return; }

        const { data } = supa.storage.from("runs-photos").getPublicUrl(filePath);
        photoUrl = data.publicUrl;
      }

      const { error } = await supa.from("ventes").insert({
        user_id: currentUser.id,
        description: desc,
        quantity: qty,
        amount: price,
        photo_url: photoUrl
      });

      if (error) { console.error(error); alert("Erreur enregistrement vente."); return; }

      document.getElementById("vente-desc").value = "";
      document.getElementById("vente-qty").value = "1";
      document.getElementById("vente-price").value = "";
      document.getElementById("vente-photo").value = "";

      await loadVentes();
      if (currentRole === "admin") {
        await refreshAdminStats();
        await refreshAdminVendorsCommissions();
      } else {
        await refreshUserFinance();
      }
    }

    async function loadVentes() {
      if (!currentUser) return;

      const { data: ventes, error } = await supa
        .from("ventes")
        .select("*")
        .eq("user_id", currentUser.id)
        .gte("created_at", sinceISO())
        .order("created_at", { ascending: false });

      if (error) { console.error(error); return; }

      const list = document.getElementById("ventes-list");
      list.innerHTML = "";

      if (!ventes || ventes.length === 0) {
        list.innerHTML = "<div class='text-sm muted'>Aucune vente sur la p√©riode.</div>";
        return;
      }

      ventes.forEach((v) => {
        const el = document.createElement("div");
        el.className = "run-item";
        el.innerHTML = `
          <div class="run-header">
            <strong>Vente #${v.id}</strong>
            <div class="run-date">${new Date(v.created_at).toLocaleString("fr-FR")}</div>
          </div>
          <div class="run-description">${escapeHtml(v.description)}</div>
          <div class="run-sales">Qt√©: ${v.quantity} ‚Ä¢ Re√ßus: ${fmtUSD(v.amount)}</div>
          ${v.photo_url ? `<div class="photos-preview"><img src="${v.photo_url}" alt="photo vente ${v.id}" /></div>` : ""}
        `;
        list.appendChild(el);
      });
    }

    // ---------------------------------------
    // ADMIN
    // ---------------------------------------
    async function loadAdminDashboard() {
      await refreshAdminStats();
      await refreshAdminUsersTable();
      await refreshAdminVentes();
      await loadAdminTransactions();
      await refreshAdminRunnersBonus();
      await refreshAdminVendorsCommissions();
    }

    async function refreshAdminStats() {
      const { count: usersCount, error: usersErr } = await supa.from("users").select("*", { count: "exact", head: true });
      if (usersErr) console.error(usersErr);

      const { count: runsCount, error: runsErr } = await supa
        .from("runs")
        .select("*", { count: "exact", head: true })
        .gte("created_at", sinceISO());
      if (runsErr) console.error(runsErr);

      const { count: photosCount, error: photosErr } = await supa
  .from("photos")
  .select("*", { count: "exact", head: true })
  .gte("created_at", sinceISO());

      if (photosErr) console.error(photosErr);

      // CA = ventes.amount + runs.sales_amount (p√©riode)
      const { data: ventesData, error: ventesErr } = await supa
        .from("ventes")
        .select("amount")
        .gte("created_at", sinceISO());
      if (ventesErr) console.error(ventesErr);

      let ventesSum = 0;
      (ventesData || []).forEach(v => { ventesSum += Number(v.amount || 0); });

      const { data: runsSalesData, error: runsSalesErr } = await supa
        .from("runs")
        .select("sales_amount")
        .gte("created_at", sinceISO());
      if (runsSalesErr) console.error(runsSalesErr);

      let runsSum = 0;
      (runsSalesData || []).forEach(r => { runsSum += Number(r.sales_amount || 0); });

      const totalCA = ventesSum + runsSum;

      // Achats mati√®re premi√®re (transactions p√©riode)
      let purchasesSum = 0;
      const { data: txData, error: txErr } = await supa
        .from("transactions")
        .select("amount,type,category,created_at")
        .gte("created_at", sinceISO());
      if (txErr) console.error(txErr);
      (txData || []).forEach(t => {
        const a = Number(t.amount || 0);
        const isPurchase = (t.type === "purchase") || (t.category === "matiere_premiere");
        if (isPurchase) purchasesSum += a;
      });

      const gross = totalCA - purchasesSum;

      document.getElementById("admin-users-count").textContent = usersCount ?? 0;
      document.getElementById("admin-runs-count").textContent = runsCount ?? 0;
      document.getElementById("admin-photos-count").textContent = photosCount ?? 0;

      document.getElementById("admin-runs-sum").textContent = fmtUSD(runsSum);
      document.getElementById("admin-ventes-sum").textContent = fmtUSD(ventesSum);
      document.getElementById("admin-sales-sum").textContent = fmtUSD(totalCA);
      document.getElementById("admin-purchases-sum").textContent = fmtUSD(purchasesSum);
      document.getElementById("admin-gross-sum").textContent = fmtUSD(gross);
    }

    async function refreshAdminUsersTable() {
      const { data, error } = await supa
        .from("users")
        .select("id, username, pin_code, role, commission_percent, created_at, runs:runs(id,created_at)")
        .order("created_at", { ascending: true });

      if (error) { console.error(error); return; }

      adminUsersCache = {};
      const tbody = document.querySelector("#admin-users-table tbody");
      tbody.innerHTML = "";

      if (!data || data.length === 0) {
        tbody.innerHTML = "<tr><td colspan='4' class='text-sm muted'>Aucun utilisateur.</td></tr>";
        return;
      }

      data.forEach((user) => {
        adminUsersCache[user.id] = user;

        const runsPeriod = (user.runs || []).filter(r => {
          try { return new Date(r.created_at).toISOString() >= sinceISO(); } catch(e){ return true; }
        });
        const runsCount = runsPeriod.length;

        const username = user.username || ("Utilisateur #" + user.id);
        const role = user.role || "user";
        const roleClass = (role === "admin") ? "admin" : (role === "runner" ? "runner" : (role === "vendeur" ? "vendeur" : "user"));

        const tr = document.createElement("tr");
        tr.dataset.userId = user.id;
        tr.innerHTML = `
          <td>${escapeHtml(username)}</td>
          <td>${escapeHtml(user.pin_code)}</td>
          <td><span class="pill-role ${roleClass}">${escapeHtml(role.toUpperCase())}</span></td>
          <td>${runsCount}</td>
        `;
        tbody.appendChild(tr);
      });

      tbody.querySelectorAll("tr").forEach((row) => {
        row.addEventListener("click", async () => {
          const userId = row.dataset.userId;
          await loadAdminUserDetails(userId);
        });
      });
    }

    async function loadAdminUserDetails(userId) {
      adminSelectedUserId = userId;

      const { data: user, error } = await supa.from("users").select("*").eq("id", userId).maybeSingle();
      if (error || !user) { console.error(error); return; }

      const username = user.username || ("Utilisateur #" + user.id);
      document.getElementById("admin-selected-user").textContent =
        `${username} (PIN: ${user.pin_code}, r√¥le: ${user.role || "user"})`;

      document.getElementById("admin-user-name").value = user.username || "";
      document.getElementById("admin-user-pin").value = user.pin_code || "";
      document.getElementById("admin-user-role").value = user.role || "user";

      const commissionRow = document.getElementById("vendor-commission-row");
      const commissionInput = document.getElementById("admin-user-commission");
      const isVendor = (user.role === "vendeur");
      if (commissionRow) commissionRow.style.display = isVendor ? "flex" : "none";
      if (commissionInput) commissionInput.value = isVendor ? String(user.commission_percent ?? 0) : "";
      document.getElementById("btn-admin-delete-user").classList.remove("hidden");

      const { data: runs, error: runsErr } = await supa
        .from("runs")
        .select("id, description, sales_description, sales_amount, created_at, photos:photos(url)")
        .eq("user_id", user.id)
        .gte("created_at", sinceISO())
        .order("created_at", { ascending: false });

      if (runsErr) { console.error(runsErr); return; }

      const runsEl = document.getElementById("admin-selected-runs");
      runsEl.innerHTML = "";

      if (!runs || runs.length === 0) {
        runsEl.innerHTML = "<div class='text-sm muted'>Aucun run pour cet utilisateur sur la p√©riode.</div>";
        return;
      }

      runs.forEach((run) => {
        const createdAt = run.created_at ? new Date(run.created_at).toLocaleString("fr-FR") : "-";
        const salesDesc = run.sales_description || "";
        const salesAmount = run.sales_amount || 0;
        const photos = run.photos || [];

        const el = document.createElement("div");
        el.className = "run-item";
        el.innerHTML = `
          <div class="run-header">
            <div><strong>Run #${run.id}</strong></div>
            <div class="run-date">${escapeHtml(createdAt)}</div>
          </div>
          <div class="run-description">${escapeHtml(run.description || "")}</div>
          ${(salesDesc || salesAmount) ? `
            <div class="run-sales">$ re√ßus: ${salesDesc ? escapeHtml(salesDesc) + " ‚Äî " : ""}${salesAmount ? fmtUSD(salesAmount) : ""}</div>` : ""
          }
          ${photos.length ? `<div class="photos-preview">${photos.map(p => `<img src="${p.url}" alt="photo run ${run.id}" />`).join("")}</div>` : ""}
        `;
        runsEl.appendChild(el);
      });
    }

    async function refreshAdminVentes() {
      const { data: ventes, error } = await supa
        .from("ventes")
        .select("*")
        .gte("created_at", sinceISO())
        .order("created_at", { ascending: false });
      if (error) { console.error(error); return; }

      const tbody = document.querySelector("#admin-ventes-table tbody");
      tbody.innerHTML = "";

      if (!ventes || ventes.length === 0) {
        tbody.innerHTML = "<tr><td colspan='7' class='text-sm muted'>Aucune vente sur la p√©riode.</td></tr>";
        return;
      }

      ventes.forEach((v) => {
        const user = adminUsersCache[v.user_id];
        const username = user ? (user.username || ("User #" + user.id)) : ("ID " + v.user_id);

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${v.id}</td>
          <td>${escapeHtml(username)}</td>
          <td>${escapeHtml(v.description)}</td>
          <td>${v.quantity}</td>
          <td>${fmtUSD(v.amount)}</td>
          <td>${new Date(v.created_at).toLocaleString("fr-FR")}</td>
          <td>${v.photo_url ? `<img src="${v.photo_url}" alt="vente ${v.id}" style="width:52px;height:52px;border-radius:12px;object-fit:cover;border:1px solid rgba(255,122,144,.45);">` : "-"}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function adminSaveUser() {
      const name = document.getElementById("admin-user-name").value.trim();
      const pin = document.getElementById("admin-user-pin").value.trim();
      const role = document.getElementById("admin-user-role").value || "user";
      const commissionInput = document.getElementById("admin-user-commission");
      const commissionPercentRaw = commissionInput ? commissionInput.value : "";
      const commissionPercent = Number(commissionPercentRaw || (role === "vendeur" ? 15 : 0));

      if (!pin || pin.length !== 4 || !/^\d{4}$/.test(pin)) { alert("Le Code PIN doit √™tre 4 chiffres."); return; }
      if (!name) { alert("Merci d'indiquer un nom / pseudo."); return; }

      try {
        if (adminSelectedUserId) {
          const { error } = await supa.from("users").update({ username: name, pin_code: pin, role, commission_percent: (role === "vendeur" ? commissionPercent : 0) }).eq("id", adminSelectedUserId);
          if (error) { console.error(error); alert("Erreur mise √† jour de l'utilisateur."); return; }
        } else {
          const { error } = await supa.from("users").insert({ username: name, pin_code: pin, role, commission_percent: (role === "vendeur" ? commissionPercent : 0) });
          if (error) { console.error(error); alert("Erreur cr√©ation utilisateur."); return; }
        }

        await refreshAdminUsersTable();
        await refreshAdminStats();
        await refreshAdminVentes();

        adminSelectedUserId = null;
        document.getElementById("admin-selected-user").textContent = "Aucun utilisateur s√©lectionn√©.";
        document.getElementById("admin-selected-runs").innerHTML = "";
        document.getElementById("btn-admin-delete-user").classList.add("hidden");
        document.getElementById("admin-user-name").value = "";
        document.getElementById("admin-user-pin").value = "";
        document.getElementById("admin-user-role").value = "user";
        const commissionRow = document.getElementById("vendor-commission-row");
        if (commissionRow) commissionRow.style.display = "none";
        if (commissionInput) commissionInput.value = "";
      } catch (err) {
        console.error(err);
        alert("Erreur inattendue pendant la sauvegarde.");
      }
    }

    async function adminDeleteUser() {
      if (!adminSelectedUserId) return;

      const confirmDelete = confirm("Supprimer cet utilisateur ? (ses runs/photos peuvent rester si tu ne les supprimes pas s√©par√©ment)");
      if (!confirmDelete) return;

      try {
        const { error } = await supa.from("users").delete().eq("id", adminSelectedUserId);
        if (error) { console.error(error); alert("Erreur suppression utilisateur."); return; }

        adminSelectedUserId = null;
        document.getElementById("admin-selected-user").textContent = "Aucun utilisateur s√©lectionn√©.";
        document.getElementById("admin-selected-runs").innerHTML = "";
        document.getElementById("btn-admin-delete-user").classList.add("hidden");
        document.getElementById("admin-user-name").value = "";
        document.getElementById("admin-user-pin").value = "";
        document.getElementById("admin-user-role").value = "user";
        const commissionRow = document.getElementById("vendor-commission-row");
        if (commissionRow) commissionRow.style.display = "none";
        const commissionInput = document.getElementById("admin-user-commission");
        if (commissionInput) commissionInput.value = "";

        await refreshAdminUsersTable();
        await refreshAdminStats();
        await refreshAdminVentes();
      } catch (err) {
        console.error(err);
        alert("Erreur inattendue pendant la suppression.");
      }
    }

    // ---------------------------------------
    // ü•Å TOMBOLA
    // ---------------------------------------
    function setupTombolaMode(){
      const tag = document.getElementById("tombola-mode-tag");
      const isAdmin = currentRole === "admin";
      tag.textContent = isAdmin ? "Admin" : "Lecture";

      document.getElementById("btn-tombola-add").style.display = isAdmin ? "inline-flex" : "none";
      document.getElementById("btn-tombola-draw").style.display = isAdmin ? "inline-flex" : "none";
      document.getElementById("tombola-admin-form").style.display = isAdmin ? "flex" : "none";
    }

    async function loadTombola(){
      const participantsEl = document.getElementById("tombola-participants");
      const totalTicketsEl = document.getElementById("tombola-total-tickets");
      const drawsEl = document.getElementById("tombola-draws");
      participantsEl.innerHTML = "";
      drawsEl.innerHTML = "";
      totalTicketsEl.textContent = "0";

      const { data: parts, error: pErr } = await supa
        .from("tombola_participants")
        .select("*")
        .order("tickets", { ascending:false })
        .order("created_at", { ascending:false });

      if (pErr) {
        console.error(pErr);
        participantsEl.innerHTML =
          "<div class='text-sm muted'>Table tombola_participants manquante.</div>";
      } else {
        if (!parts || parts.length === 0) {
          participantsEl.innerHTML = "<div class='text-sm muted'>Aucun participant.</div>";
        } else {
          const totalTickets = parts.reduce((acc, p) => acc + Number(p.tickets || 0), 0);
          totalTicketsEl.textContent = totalTickets;

          parts.forEach((p) => {
            const item = document.createElement("div");
            item.className = "run-item";
            const name = escapeHtml(p.name);
            const contact = p.contact ? (" ‚Ä¢ " + escapeHtml(p.contact)) : "";
            const tickets = Number(p.tickets || 0);
            const products = Number(p.products_count || 0);

            item.innerHTML = `
              <div class="run-header">
                <div><strong>${name}</strong><div class="text-xs muted">${contact || ""}</div></div>
                <div class="stat-pill">tickets: <span>${tickets}</span></div>
              </div>
              <div class="text-xs muted" style="margin-top:4px;">Produits achet√©s: <strong>${products}</strong></div>
              ${currentRole === "admin" ? `
                <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap;">
                  <button class="btn-secondary btn-sm" data-add-product="${p.id}">+1 produit</button>
                  <button class="btn-secondary btn-sm" data-add-product5="${p.id}">+5 produits</button>
                  <button class="btn-danger btn-sm" data-del-part="${p.id}">Supprimer</button>
                </div>
              ` : ""}
            `;
            participantsEl.appendChild(item);
          });

          if (currentRole === "admin") {
            document.querySelectorAll("[data-add-product]").forEach(btn=>{
              btn.addEventListener("click", async ()=>{
                await addProductsToParticipant(btn.getAttribute("data-add-product"), 1);
                await loadTombola();
              });
            });
            document.querySelectorAll("[data-add-product5]").forEach(btn=>{
              btn.addEventListener("click", async ()=>{
                await addProductsToParticipant(btn.getAttribute("data-add-product5"), 5);
                await loadTombola();
              });
            });
            document.querySelectorAll("[data-del-part]").forEach(btn=>{
              btn.addEventListener("click", async ()=>{
                const id = btn.getAttribute("data-del-part");
                if (!confirm("Supprimer ce participant ?")) return;
                const { error } = await supa.from("tombola_participants").delete().eq("id", id);
                if (error) console.error(error);
                await loadTombola();
              });
            });
          }
        }
      }

      const { data: draws, error: dErr } = await supa
        .from("tombola_draws")
        .select("*")
        .order("created_at", { ascending:false })
        .limit(10);

      if (dErr) {
        console.error(dErr);
        drawsEl.innerHTML = "<div class='text-sm muted'>Table tombola_draws manquante.</div>";
      } else {
        if (!draws || draws.length === 0) {
          drawsEl.innerHTML = "<div class='text-sm muted'>Aucun tirage.</div>";
        } else {
          draws.forEach((dr) => {
            const row = document.createElement("div");
            row.className = "mini-item";
            row.innerHTML = `
              <div>
                <strong>${escapeHtml(dr.winner_name || "‚Äî")}</strong>
                <div class="mini-meta">${new Date(dr.created_at).toLocaleString("fr-FR")} ‚Ä¢ tickets gagnant: ${dr.winner_tickets || 0} ‚Ä¢ total: ${dr.total_tickets || 0}</div>
              </div>
              <div class="tag">TIRAGE</div>
            `;
            drawsEl.appendChild(row);
          });

          const last = draws[0];
          document.getElementById("tombola-winner-name").textContent = last.winner_name || "‚Äî";
          document.getElementById("tombola-winner-meta").textContent =
            `Tickets gagnant: ${last.winner_tickets || 0} ‚Ä¢ Total tickets: ${last.total_tickets || 0} ‚Ä¢ ${new Date(last.created_at).toLocaleString("fr-FR")}`;
        }
      }
    }

    async function addParticipant(){
      if (currentRole !== "admin") return;

      const name = document.getElementById("tombola-name").value.trim();
      const contact = document.getElementById("tombola-contact").value.trim();
      const products = Math.max(1, parseInt(document.getElementById("tombola-products").value || "1", 10));

      if (!name) { alert("Nom obligatoire."); return; }

      const payload = {
        name,
        contact: contact || null,
        products_count: products,
        tickets: products
      };

      const { error } = await supa.from("tombola_participants").insert(payload);
      if (error) { console.error(error); alert("Erreur inscription (table tombola_participants ?)"); return; }

      document.getElementById("tombola-name").value = "";
      document.getElementById("tombola-contact").value = "";
      document.getElementById("tombola-products").value = "1";

      await loadTombola();
    }

    async function addProductsToParticipant(participantId, addCount){
      if (currentRole !== "admin") return;

      const { data, error } = await supa
        .from("tombola_participants")
        .select("*")
        .eq("id", participantId)
        .maybeSingle();

      if (error || !data) { console.error(error); return; }

      const newProducts = Number(data.products_count || 0) + Number(addCount);
      const newTickets = Number(data.tickets || 0) + Number(addCount);

      const { error: updErr } = await supa
        .from("tombola_participants")
        .update({ products_count: newProducts, tickets: newTickets })
        .eq("id", participantId);

      if (updErr) console.error(updErr);
    }

    async function drawWinner(){
      if (currentRole !== "admin") return;

      const drum = document.getElementById("drum");
      drum.classList.add("spinning");

      const { data: parts, error } = await supa
        .from("tombola_participants")
        .select("id, name, tickets")
        .order("id", { ascending:true });

      if (error) { console.error(error); drum.classList.remove("spinning"); alert("Erreur tombola."); return; }
      if (!parts || parts.length === 0) { drum.classList.remove("spinning"); alert("Aucun participant."); return; }

      const total = parts.reduce((acc, p) => acc + Number(p.tickets || 0), 0);
      if (total <= 0) { drum.classList.remove("spinning"); alert("Tickets total = 0."); return; }

      const r = Math.floor(Math.random() * total) + 1;
      let cumulative = 0;
      let winner = null;

      for (const p of parts) {
        cumulative += Number(p.tickets || 0);
        if (r <= cumulative) { winner = p; break; }
      }
      if (!winner) winner = parts[parts.length - 1];

      await new Promise(res => setTimeout(res, 1600));
      drum.classList.remove("spinning");

      const drawRow = {
        winner_id: winner.id,
        winner_name: winner.name,
        winner_tickets: Number(winner.tickets || 0),
        total_tickets: total
      };

      const { error: dErr } = await supa.from("tombola_draws").insert(drawRow);
      if (dErr) console.error(dErr);

      await loadTombola();
      alert("üéâ Gagnant: " + winner.name);
    }

    async function resetTombola(){
      await supa.from("tombola_draws").delete().neq("id",-1);
      await supa.from("tombola_participants").delete().neq("id",-1);
    }

    // ---------------------------------------
    // üí∏ TRANSACTIONS + CALCUL CA (p√©riode)
    // ---------------------------------------
    function syncTxCategory(scope){
      const typeEl = document.getElementById(scope === "a" ? "txa-type" : "txu-type");
      const catEl  = document.getElementById(scope === "a" ? "txa-category" : "txu-category");
      if (!typeEl || !catEl) return;

      if (typeEl.value === "purchase") {
        catEl.value = "matiere_premiere";
        catEl.disabled = true;
      } else {
        catEl.disabled = false;
      }
    }

    async function addTransaction(scope){
      if (!currentUser) return;

      const typeEl  = document.getElementById(scope === "a" ? "txa-type" : "txu-type");
      const catEl   = document.getElementById(scope === "a" ? "txa-category" : "txu-category");
      const descEl  = document.getElementById(scope === "a" ? "txa-desc" : "txu-desc");
      const amtEl   = document.getElementById(scope === "a" ? "txa-amount" : "txu-amount");
      const photoEl = document.getElementById(scope === "a" ? "txa-photo" : "txu-photo");

      const type = (typeEl.value || "purchase").trim();
      const category = (catEl.value || "matiere_premiere").trim();
      const description = descEl.value.trim();
      const amount = parseFloat(amtEl.value || "0") || 0;

      if (!description || amount <= 0) {
        alert("Description + montant obligatoires.");
        return;
      }

      let photoUrl = null;
      if (photoEl && photoEl.files && photoEl.files.length > 0) {
        const file = photoEl.files[0];
        const safeName = file.name.replace(/[^a-zA-Z0-9.\-_]/g, "_");
        const filePath = `${currentUser.id}/transactions/${Date.now()}_${safeName}`;

        const { error: uploadError } = await supa.storage.from("runs-photos").upload(filePath, file);
        if (uploadError) { console.error(uploadError); alert("Erreur upload photo."); return; }

        const { data } = supa.storage.from("runs-photos").getPublicUrl(filePath);
        photoUrl = data?.publicUrl || null;
      }

      const { error } = await supa.from("transactions").insert({
        user_id: currentUser.id,
        type, category, description, amount,
        photo_url: photoUrl
      });
      if (error) {
        console.error(error);
        alert("Erreur enregistrement. (Table transactions manquante ?)");
        return;
      }

      descEl.value = "";
      amtEl.value = "";
      if (photoEl) photoEl.value = "";
      typeEl.value = "purchase";
      catEl.value = "matiere_premiere";
      syncTxCategory(scope);

      if (currentRole === "admin") {
        await loadAdminTransactions();
        await refreshAdminStats();
      } else {
        await loadUserTransactions();
        await refreshUserFinance();
      }
    }

    async function getRunsTotal(userIdOrNull){
      let total = 0;
      let q = supa.from("runs").select("sales_amount").gte("created_at", sinceISO());
      if (userIdOrNull) q = q.eq("user_id", userIdOrNull);
      const { data, error } = await q;
      if (error) { console.error(error); return 0; }
      (data || []).forEach(r => { total += Number(r.sales_amount || 0); });
      return total;
    }

    async function getVentesTotal(userIdOrNull){
      let total = 0;
      let q = supa.from("ventes").select("amount").gte("created_at", sinceISO());
      if (userIdOrNull) q = q.eq("user_id", userIdOrNull);
      const { data, error } = await q;
      if (error) { console.error(error); return 0; }
      (data || []).forEach(v => { total += Number(v.amount || 0); });
      return total;
    }

    async function getPurchasesTotal(userIdOrNull){
      let total = 0;
      let q = supa.from("transactions").select("amount,type,category,created_at").gte("created_at", sinceISO());
      if (userIdOrNull) q = q.eq("user_id", userIdOrNull);
      const { data, error } = await q;
      if (error) { console.error(error); return 0; }

      (data || []).forEach(t => {
        const a = Number(t.amount || 0);
        const isPurchase = (t.type === "purchase") || (t.category === "matiere_premiere");
        if (isPurchase) total += a;
      });
      return total;
    }

    async function loadUserTransactions(){
      if (!currentUser) return;
      const list = document.getElementById("user-transactions-list");
      list.innerHTML = "";

      const { data, error } = await supa
        .from("transactions")
        .select("*")
        .eq("user_id", currentUser.id)
        .gte("created_at", sinceISO())
        .order("created_at", { ascending:false })
        .limit(80);

      if (error) {
        console.error(error);
        list.innerHTML = "<div class='text-sm muted'>Table transactions manquante.</div>";
        return;
      }

      if (!data || data.length === 0) {
        list.innerHTML = "<div class='text-sm muted'>Aucune d√©pense / achat sur la p√©riode.</div>";
        return;
      }

      data.forEach((t) => {
        const typeLabel = t.type === "purchase" ? "Achat" : "D√©pense";
        const cat = t.category ? ` ‚Ä¢ ${escapeHtml(t.category)}` : "";
        const el = document.createElement("div");
        el.className = "run-item";
        el.innerHTML = `
          <div class="run-header">
            <strong>${escapeHtml(typeLabel)} #${t.id}</strong>
            <div class="run-date">${t.created_at ? new Date(t.created_at).toLocaleString("fr-FR") : "-"}</div>
          </div>
          <div class="run-description">${escapeHtml(t.description || "")}</div>
          <div class="run-sales">${escapeHtml(cat)} ‚Ä¢ Montant: ${fmtUSD(t.amount)}</div>
          ${t.photo_url ? `<div class="photos-preview"><img src="${t.photo_url}" alt="transaction ${t.id}" /></div>` : ""}
        `;
        list.appendChild(el);
      });
    }

    async function loadAdminTransactions(){
      if (!currentUser) return;
      const list = document.getElementById("admin-transactions-list");
      list.innerHTML = "";

      const { data, error } = await supa
        .from("transactions")
        .select("*")
        .gte("created_at", sinceISO())
        .order("created_at", { ascending:false })
        .limit(120);

      if (error) {
        console.error(error);
        list.innerHTML = "<div class='text-sm muted'>Table transactions manquante.</div>";
        return;
      }

      if (!data || data.length === 0) {
        list.innerHTML = "<div class='text-sm muted'>Aucune transaction sur la p√©riode.</div>";
        return;
      }

      data.forEach((t) => {
        const typeLabel = t.type === "purchase" ? "Achat" : "D√©pense";
        const user = adminUsersCache[t.user_id];
        const username = user ? (user.username || ("User #" + user.id)) : ("ID " + t.user_id);

        const el = document.createElement("div");
        el.className = "run-item";
        el.innerHTML = `
          <div class="run-header">
            <strong>${escapeHtml(typeLabel)} #${t.id}</strong>
            <div class="run-date">${t.created_at ? new Date(t.created_at).toLocaleString("fr-FR") : "-"}</div>
          </div>
          <div class="run-description">${escapeHtml(t.description || "")}</div>
          <div class="run-sales">${escapeHtml(username)} ‚Ä¢ ${escapeHtml(t.category || "")} ‚Ä¢ Montant: ${fmtUSD(t.amount)}</div>
          ${t.photo_url ? `<div class="photos-preview"><img src="${t.photo_url}" alt="transaction ${t.id}" /></div>` : ""}
        `;
        list.appendChild(el);
      });
    }

    // ---------------------------------------
    // üèÉ RUNNERS ‚Äî prime / grade
    // ---------------------------------------
    function computeRunnerGrade(count){
  if (count >= BONUS_TIER2_RUNS) return "Silver II";
  if (count >= BONUS_TIER1_RUNS) return "Silver I";
  return "Bronze";
}

    function computeRunnerBonus(count){
      if (count >= BONUS_TIER2_RUNS) return BONUS_TIER2_AMOUNT;
      if (count >= BONUS_TIER1_RUNS) return BONUS_TIER1_AMOUNT;
      return 0;
    }

    async function getWeeklyRunsMap(){
  // ‚úÖ maintenant: depuis week_start (p√©riode), pas "7 jours glissants"
  const since = sinceISO();
  const { data, error } = await supa
    .from("runs")
    .select("user_id, created_at")
    .gte("created_at", since);

  if (error) { console.error(error); return {}; }

  const map = {};
  (data || []).forEach(r => {
    const uid = r.user_id;
    if (!uid) return;
    map[uid] = (map[uid] || 0) + 1;
  });
  return map;
}


    async function refreshRunnerWeekly(){
      if (!currentUser) return;
      const panel = document.getElementById("runner-weekly-panel");
      if (!panel) return;

      if (currentRole !== "runner") {
        panel.classList.add("hidden");
        return;
      }
      panel.classList.remove("hidden");

      const map = await getWeeklyRunsMap();
      const count = map[currentUser.id] || 0;
      const grade = computeRunnerGrade(count);
      const bonus = computeRunnerBonus(count);

      document.getElementById("user-weekly-runs").textContent = String(count);
      document.getElementById("user-weekly-grade").textContent = grade;
      document.getElementById("user-weekly-bonus").textContent = fmtUSD(bonus);
    }

    // ---------------------------------------
    // üí∞ VENDEUR ‚Äî commissions
    // ---------------------------------------
    async function refreshVendorEarnings(){
      if (!currentUser) return;
      const panel = document.getElementById("vendor-commission-panel");
      if (!panel) return;

      if (currentRole !== "vendeur") {
        panel.classList.add("hidden");
        return;
      }
      panel.classList.remove("hidden");

      const pct = Number(currentUser.commission_percent || 0);
      const ventes = await getVentesTotal(currentUser.id);
      const gain = ventes * (pct / 100);

      document.getElementById("user-commission-percent").textContent = `${pct}%`;
      document.getElementById("user-vendor-ventes-sum").textContent = fmtUSD(ventes);
      document.getElementById("user-commission-earnings").textContent = fmtUSD(gain);
    }

    async function refreshAdminRunnersBonus(){
      const tableBody = document.querySelector("#admin-runners-bonus-table tbody");
      if (!tableBody) return;

      tableBody.innerHTML = "<tr><td colspan='4' class='text-sm muted'>Chargement‚Ä¶</td></tr>";

      const { data: runners, error: uErr } = await supa
        .from("users")
        .select("id, username, role")
        .eq("role", "runner")
        .order("created_at", { ascending: true });

      if (uErr) { console.error(uErr); tableBody.innerHTML = "<tr><td colspan='4' class='text-sm muted'>Erreur chargement runners.</td></tr>"; return; }

      if (!runners || runners.length === 0) {
        tableBody.innerHTML = "<tr><td colspan='4' class='text-sm muted'>Aucun runner.</td></tr>";
        return;
      }

      const weeklyMap = await getWeeklyRunsMap();

      tableBody.innerHTML = "";
      runners.forEach(r => {
        const count = weeklyMap[r.id] || 0;
        const grade = computeRunnerGrade(count);
        const bonus = computeRunnerBonus(count);

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(r.username || ("Runner #" + r.id))}</td>
          <td>${count}</td>
          <td><span class="badge-soft">${grade}</span></td>
          <td>${fmtUSD(bonus)}</td>
        `;
        tableBody.appendChild(tr);
      });
    }

    async function refreshAdminVendorsCommissions(){
      const tableBody = document.querySelector("#admin-vendors-commission-table tbody");
      if (!tableBody) return;

      tableBody.innerHTML = "<tr><td colspan='4' class='text-sm muted'>Chargement‚Ä¶</td></tr>";

      const { data: vendors, error: uErr } = await supa
        .from("users")
        .select("id, username, role, commission_percent")
        .eq("role", "vendeur")
        .order("created_at", { ascending: true });

      if (uErr) { console.error(uErr); tableBody.innerHTML = "<tr><td colspan='4' class='text-sm muted'>Erreur chargement vendeurs.</td></tr>"; return; }

      if (!vendors || vendors.length === 0) {
        tableBody.innerHTML = "<tr><td colspan='4' class='text-sm muted'>Aucun vendeur.</td></tr>";
        return;
      }

      const { data: ventes, error: vErr } = await supa
        .from("ventes")
        .select("user_id, amount, created_at")
        .gte("created_at", sinceISO());
      if (vErr) { console.error(vErr); tableBody.innerHTML = "<tr><td colspan='4' class='text-sm muted'>Erreur chargement ventes.</td></tr>"; return; }

      const sumMap = {};
      (ventes || []).forEach(v => {
        const uid = v.user_id;
        if (!uid) return;
        sumMap[uid] = (sumMap[uid] || 0) + Number(v.amount || 0);
      });

      tableBody.innerHTML = "";
      vendors.forEach(v => {
        const ventesSum = sumMap[v.id] || 0;
        const pct = Number(v.commission_percent || 0);
        const gain = ventesSum * (pct / 100);

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(v.username || ("Vendeur #" + v.id))}</td>
          <td>${pct}%</td>
          <td>${fmtUSD(ventesSum)}</td>
          <td>${fmtUSD(gain)}</td>
        `;
        tableBody.appendChild(tr);
      });
    }

    async function refreshUserFinance(){
      if (!currentUser) return;

      const caEl = document.getElementById("user-ca-sum");
      const purchasesEl = document.getElementById("user-purchases-sum");
      const grossEl = document.getElementById("user-gross-sum");
      const runsEl = document.getElementById("user-runs-sum");
      const ventesEl = document.getElementById("user-ventes-sum");

      const [runs, ventes, purchases] = await Promise.all([
        getRunsTotal(currentUser.id),
        getVentesTotal(currentUser.id),
        getPurchasesTotal(currentUser.id)
      ]);

      const ca = runs + ventes;
      const gross = ca - purchases;

      if (runsEl) runsEl.textContent = fmtUSD(runs);
      if (ventesEl) ventesEl.textContent = fmtUSD(ventes);

      caEl.textContent = fmtUSD(ca);
      purchasesEl.textContent = fmtUSD(purchases);
      grossEl.textContent = fmtUSD(gross);

      if (currentRole === "vendeur") await refreshVendorEarnings();
      if (currentRole === "runner") await refreshRunnerWeekly();
    }

    // ---------------------------------------
    // ‚úÖ PDF SEMAINE + REPORTS
    // ---------------------------------------
    async function buildWeekStats(){
      const periodStart = sinceISO();
      const periodEnd = new Date().toISOString();

      const { data: users } = await supa.from("users").select("id, username, role, commission_percent");
      const { data: runs }  = await supa.from("runs").select("user_id, sales_amount, created_at").gte("created_at", periodStart);
      const { data: ventes } = await supa.from("ventes").select("user_id, amount, created_at").gte("created_at", periodStart);
      const { data: tx } = await supa.from("transactions").select("user_id, amount, type, category, created_at").gte("created_at", periodStart);

      const userMap = {};
      (users || []).forEach(u => {
        userMap[u.id] = {
          id: u.id,
          name: u.username || ("User #" + u.id),
          role: u.role || "user",
          commission: Number(u.commission_percent || 0),
          runsCount: 0,
          runsSum: 0,
          ventesCount: 0,
          ventesSum: 0,
          purchasesSum: 0
        };
      });

      (runs || []).forEach(r => {
        const u = userMap[r.user_id]; if (!u) return;
        u.runsCount += 1;
        u.runsSum += Number(r.sales_amount || 0);
      });

      (ventes || []).forEach(v => {
        const u = userMap[v.user_id]; if (!u) return;
        u.ventesCount += 1;
        u.ventesSum += Number(v.amount || 0);
      });

      (tx || []).forEach(t => {
        const u = userMap[t.user_id]; if (!u) return;
        const isPurchase = (t.type === "purchase") || (t.category === "matiere_premiere");
        if (isPurchase) u.purchasesSum += Number(t.amount || 0);
      });

      const rows = Object.values(userMap)
        .filter(u => (u.runsCount + u.ventesCount + u.purchasesSum) > 0)
        .sort((a,b)=> (b.runsSum+b.ventesSum) - (a.runsSum+b.ventesSum));

      const runsSum = rows.reduce((a,u)=>a+u.runsSum,0);
      const ventesSum = rows.reduce((a,u)=>a+u.ventesSum,0);
      const purchasesSum = rows.reduce((a,u)=>a+u.purchasesSum,0);
      const totalCA = runsSum + ventesSum;

      return { periodStart, periodEnd, rows, runsSum, ventesSum, purchasesSum, totalCA };
    }

    async function exportWeekPDF(andUpload=true){
      const stats = await buildWeekStats();

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:"pt", format:"a4" });

      doc.setFont("helvetica","bold");
      doc.setFontSize(16);
      doc.text("Punk Noodles ‚Äî Rapport Semaine", 40, 48);

      doc.setFont("helvetica","normal");
      doc.setFontSize(10);
      doc.text(`P√©riode: ${toFr(stats.periodStart)}  ‚Üí  ${toFr(stats.periodEnd)}`, 40, 68);

      doc.setFont("helvetica","bold");
      doc.text(`Totaux: Runs ${fmtUSD(stats.runsSum)} | Ventes ${fmtUSD(stats.ventesSum)} | CA ${fmtUSD(stats.totalCA)} | Achats ${fmtUSD(stats.purchasesSum)}`, 40, 86);

      const tableBody = stats.rows.map(u => ([
        u.name,
        u.role,
        String(u.runsCount),
        fmtUSD(u.runsSum),
        String(u.ventesCount),
        fmtUSD(u.ventesSum),
        fmtUSD(u.runsSum + u.ventesSum),
        fmtUSD(u.purchasesSum)
      ]));

      doc.autoTable({
        startY: 110,
        head: [["Personne","R√¥le","Runs","Runs $","Ventes","Ventes $","CA","Achats MP"]],
        body: tableBody,
        styles: { fontSize: 9 },
        headStyles: { fillColor: [30,30,30] }
      });

      const safeStart = new Date(stats.periodStart).toISOString().slice(0,10);
      const safeEnd = new Date(stats.periodEnd).toISOString().slice(0,10);
      const filename = `punknoodles_rapport_${safeStart}_to_${safeEnd}.pdf`;

      // download local
      doc.save(filename);

      if (!andUpload) return;

      // upload to storage
      try{
        const blob = doc.output("blob");
        const path = `${Date.now()}_${filename}`;

        const up = await supa.storage.from("weekly-reports").upload(path, blob, { contentType:"application/pdf" });
        if (up.error) {
          console.error(up.error);
          alert("PDF g√©n√©r√© mais upload impossible. V√©rifie bucket weekly-reports (public).");
          return;
        }

        const { data: pub } = supa.storage.from("weekly-reports").getPublicUrl(path);
        const reportUrl = pub?.publicUrl;

        const ins = await supa.from("weekly_reports").insert({
          period_start: stats.periodStart,
          period_end: stats.periodEnd,
          runs_sum: stats.runsSum,
          ventes_sum: stats.ventesSum,
          purchases_sum: stats.purchasesSum,
          total_ca: stats.totalCA,
          report_url: reportUrl
        });

        if (ins.error) {
          console.error(ins.error);
          alert("PDF upload OK, mais insertion weekly_reports impossible. V√©rifie la table.");
          return;
        }

        await loadReports();
      } catch(e){
        console.error(e);
        alert("Erreur g√©n√©ration/upload PDF (voir console).");
      }
    }

    async function loadReports(){
      const list = document.getElementById("admin-reports-list");
      if (!list) return;

      list.innerHTML = "<div class='text-sm muted'>Chargement‚Ä¶</div>";

      const { data, error } = await supa
        .from("weekly_reports")
        .select("*")
        .order("created_at", { ascending:false })
        .limit(12);

      if (error) {
        console.error(error);
        list.innerHTML = "<div class='text-sm muted'>Table weekly_reports manquante.</div>";
        return;
      }

      if (!data || data.length === 0) {
        list.innerHTML = "<div class='text-sm muted'>Aucun rapport enregistr√©.</div>";
        return;
      }

      list.innerHTML = "";
      data.forEach(r => {
        const el = document.createElement("div");
        el.className = "run-item";
        el.innerHTML = `
          <div class="run-header">
            <strong>Rapport #${r.id}</strong>
            <div class="run-date">${toFr(r.created_at)}</div>
          </div>
          <div class="run-description">P√©riode: ${toFr(r.period_start)} ‚Üí ${toFr(r.period_end)}</div>
          <div class="run-sales">CA: ${fmtUSD(r.total_ca)} ‚Ä¢ Runs: ${fmtUSD(r.runs_sum)} ‚Ä¢ Ventes: ${fmtUSD(r.ventes_sum)} ‚Ä¢ Achats: ${fmtUSD(r.purchases_sum)}</div>
          <div style="margin-top:8px;">
            <a class="btn-secondary btn-sm" style="display:inline-block;text-decoration:none;padding:6px 10px;border-radius:12px;"
               href="${r.report_url}" target="_blank">Ouvrir PDF</a>
          </div>
        `;
        list.appendChild(el);
      });
    }

    async function closeWeek(){
      if (currentRole !== "admin") return;

      const ok = confirm("Cl√¥turer la semaine ?\n‚û°Ô∏è G√©n√®re PDF + reset p√©riode (week_start) + reset tombola + lib√®re voitures.");
      if (!ok) return;

      // 1) PDF + upload
      await exportWeekPDF(true);

      // 2) reset tombola + cars
      await resetTombola();
      await releaseAllCars();

      // 3) set new week_start = now
     // 3) set new week_start = now (EN BASE, sinon on ne continue pas)
const nowISO = new Date().toISOString();

const upd = await supa
  .from("app_settings")
  .upsert({ key:"week_start", value: nowISO, updated_at: nowISO });

if (upd.error) {
  console.error("‚ùå Impossible d'√©crire week_start en base:", upd.error);
  alert("‚ùå Reset impossible: Supabase refuse l'update week_start (RLS/policy). Regarde la console.");
  return; // üî• important : ne pas reset l'UI si la base ne suit pas
}

WEEK_START_ISO = nowISO;
updateHeaderPeriod();


      // refresh UI
      await loadTombola();
      await loadCars();
      await loadAdminDashboard();
      await loadReports();

      alert("‚úÖ Semaine cl√¥tur√©e. Nouvelle p√©riode d√©marr√©e maintenant.");
    }

    // ---------------------------------------
    // Logout
    // ---------------------------------------
    function logout() {
      currentUser = null;
      currentRole = null;
      adminSelectedUserId = null;
      WEEK_START_ISO = null;

      document.getElementById("main-header").classList.add("hidden");
      document.getElementById("user-section").classList.add("hidden");
      document.getElementById("admin-section").classList.add("hidden");
      document.getElementById("pin-overlay").classList.remove("hidden");

      clearPin();

      document.getElementById("cars-list").innerHTML = "";
      document.getElementById("tombola-participants").innerHTML = "";
      document.getElementById("tombola-draws").innerHTML = "";
      document.getElementById("tombola-total-tickets").textContent = "0";
      document.getElementById("tombola-winner-name").textContent = "‚Äî";
      document.getElementById("tombola-winner-meta").textContent = "‚Äî";

      document.getElementById("header-period")?.classList.add("hidden");
    }

    // ---------------------------------------
    // INIT
    // ---------------------------------------
    document.addEventListener("DOMContentLoaded", () => {
      setupPinPad();

      document.getElementById("btn-add-run")?.addEventListener("click", addRun);
      document.getElementById("btn-add-vente")?.addEventListener("click", addVente);
      document.getElementById("btn-logout")?.addEventListener("click", logout);

      document.getElementById("btn-admin-save-user")?.addEventListener("click", adminSaveUser);
      document.getElementById("btn-admin-delete-user")?.addEventListener("click", adminDeleteUser);

      document.getElementById("admin-user-role")?.addEventListener("change", () => {
        const role = document.getElementById("admin-user-role")?.value;
        const row = document.getElementById("vendor-commission-row");
        const input = document.getElementById("admin-user-commission");
        if (!row) return;
        if (role === "vendeur") {
          row.style.display = "flex";
          if (input && !input.value) input.value = "15";
        } else {
          row.style.display = "none";
          if (input) input.value = "";
        }
      });

      document.getElementById("btn-refresh-bonus")?.addEventListener("click", () => refreshAdminRunnersBonus());
      document.getElementById("btn-refresh-commissions")?.addEventListener("click", () => refreshAdminVendorsCommissions());

      document.getElementById("btn-article")?.addEventListener("click", () => {
        window.location.href = "article.html";
      });

      document.getElementById("btn-tombola-add")?.addEventListener("click", addParticipant);
      document.getElementById("btn-tombola-refresh")?.addEventListener("click", loadTombola);
      document.getElementById("btn-tombola-draw")?.addEventListener("click", drawWinner);

      document.getElementById("txu-type")?.addEventListener("change", () => syncTxCategory("u"));
      document.getElementById("txa-type")?.addEventListener("change", () => syncTxCategory("a"));

      document.getElementById("btn-add-txu")?.addEventListener("click", () => addTransaction("u"));
      document.getElementById("btn-add-txa")?.addEventListener("click", () => addTransaction("a"));
      document.getElementById("btn-refresh-txa")?.addEventListener("click", loadAdminTransactions);

      // ‚úÖ PDF / Reset semaine
      document.getElementById("btn-export-week-pdf")?.addEventListener("click", () => exportWeekPDF(true));
      document.getElementById("btn-close-week")?.addEventListener("click", closeWeek);
      document.getElementById("btn-refresh-reports")?.addEventListener("click", loadReports);

      syncTxCategory("u");
      syncTxCategory("a");
    });
  </script>
</body>
</html>
